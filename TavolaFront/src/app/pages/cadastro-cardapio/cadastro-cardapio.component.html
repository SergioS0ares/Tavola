<div class="cardapio-container">
  <!-- Page Header usando estilos globais -->
  <div class="tavola-page-header cardapio">
    <div class="header-content">
      <div class="header-icon">
        <mat-icon>restaurant_menu</mat-icon>
      </div>
      <div class="header-text">
        <h1>Cadastro de Cardápio</h1>
        <p>Gerencie os itens do seu cardápio de forma simples e eficiente.</p>
      </div>
      <button
        mat-fab
        color="primary"
        class="tavola-fab"
        aria-label="Adicionar item"
        matTooltip="Adicionar novo item ao cardápio"
        matTooltipClass="tavola-tooltip"
        [matTooltipDisabled]="isMobile"
        (click)="adicionar()">
        <mat-icon>add</mat-icon>
      </button>
    </div>
  </div>

  <span *ngIf="mensagemSucesso" class="mensagem-sucesso">{{ mensagemSucesso }}</span>

  <!-- Campo de Busca e Filtros -->
  <div *ngIf="!isLoading && itens.length > 0" class="search-section">
    <div class="search-container">
      <div class="search-row">
        <mat-form-field appearance="outline" class="tavola-search-field">
          <mat-label>Buscar item do cardápio</mat-label>
          <input matInput 
            [(ngModel)]="pesquisa" 
            (input)="aplicarFiltros()"
            placeholder="Digite o nome, categoria ou tag do item">
          <button mat-icon-button matSuffix *ngIf="pesquisa" (click)="limparPesquisa()" aria-label="Limpar pesquisa">
            <mat-icon>close</mat-icon>
          </button>
          <button mat-icon-button matSuffix *ngIf="!pesquisa" aria-label="Buscar">
            <mat-icon>search</mat-icon>
          </button>
        </mat-form-field>
        
        <!-- Botão de filtros avançados -->
        <button mat-icon-button 
                class="filter-button" 
                [matMenuTriggerFor]="filterMenu"
                #filterMenuTrigger="matMenuTrigger"
                matTooltip="Filtros avançados"
                matTooltipClass="tavola-tooltip"
                [matTooltipDisabled]="isMobile">
          <mat-icon>tune</mat-icon>
        </button>
        
        <!-- Menu de filtros -->
        <mat-menu #filterMenu="matMenu" class="tavola-menu-bar" (menuClosed)="onMenuClosed($event)">
          <div class="filter-menu-content" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
            <div class="filter-header">
              <h4>Filtros</h4>
              <button mat-icon-button (click)="limparFiltros(); $event.stopPropagation()" matTooltip="Limpar filtros" [matTooltipDisabled]="isMobile">
                <mat-icon>clear</mat-icon>
              </button>
            </div>
            
            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Categoria</mat-label>
              <mat-select [(ngModel)]="categoriaFiltro" (selectionChange)="aplicarFiltrosSemFechar()" (click)="$event.stopPropagation()">
                <mat-option value="">Todas as categorias</mat-option>
                <mat-option *ngFor="let categoria of categorias" [value]="categoria.nome" (click)="$event.stopPropagation(); $event.preventDefault()">
                  {{ categoria.nome }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            
            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Tags</mat-label>
              <mat-select [(ngModel)]="tagFiltro" (selectionChange)="aplicarFiltrosSemFechar()" multiple (click)="$event.stopPropagation()">
                <mat-option *ngFor="let tag of tagsDisponiveis" [value]="tag" (click)="$event.stopPropagation(); $event.preventDefault()">
                  {{ tag }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            
            <div class="filter-options">
              <mat-checkbox [(ngModel)]="apenasDisponiveis" (change)="aplicarFiltrosSemFechar()" (click)="$event.stopPropagation()">
                Apenas disponíveis
              </mat-checkbox>
            </div>
          </div>
        </mat-menu>
      </div>
    </div>
  </div>

  <!-- Improved category sections with modern styling -->
  <ng-container *ngFor="let categoria of categoriasComItensFiltradas">
    <div class="categoria-section" *ngIf="categoria.itens.length > 0">
      <div class="categoria-header">
        <h3 class="categoria-titulo">{{ categoria.nome }}</h3>
        <span class="categoria-count">{{ categoria.itens.length }} {{ categoria.itens.length === 1 ? 'item' : 'itens' }}</span>
      </div>
      
      <div class="cardapio-grid">
        <mat-card *ngFor="let item of categoria.itens" class="cardapio-card" [class.indisponivel]="!item.disponivel">
          
          <!-- Improved card image container with better badge positioning -->
          <div class="card-image-container">
            <img mat-card-image [src]="item.imagem || defaultImg" alt="{{ item.nome }}" />
            
            <div class="status-badges">
              <span class="badge indisponivel" *ngIf="!item.disponivel">
                <mat-icon>block</mat-icon>
                Indisponível
              </span>
            </div>
            
            <div class="card-tags" *ngIf="item.tags && item.tags.length > 0">
              <span *ngFor="let tag of getTagsNormalizadas(item.tags)" class="tag">
                {{ tag }}
              </span>
            </div>

            <button mat-icon-button class="more-button" [matMenuTriggerFor]="menu" 
                    #itemMenuTrigger="matMenuTrigger"
                    matTooltip="Mais opções" matTooltipClass="tavola-tooltip"
                    [matTooltipDisabled]="isMobile">
              <mat-icon>more_vert</mat-icon>
            </button>
          </div>
          
          <!-- Improved card content layout -->
          <mat-card-content class="card-content">
            <div class="card-header">
              <h3 class="card-title">{{ item.nome }}</h3>
              <mat-slide-toggle
                [checked]="item.disponivel"
                (change)="toggleDisponibilidade(item)"
                color="primary"
                [matTooltip]="item.disponivel ? 'Item disponível' : 'Item indisponível'"
                matTooltipClass="tavola-tooltip"
                [matTooltipDisabled]="isMobile">
              </mat-slide-toggle>
            </div>
            
            <p class="card-description" *ngIf="item.descricao">{{ item.descricao }}</p>
            
            <div class="card-footer">
              <div class="preco-section">
                <mat-icon>attach_money</mat-icon>
                <span class="preco">R$ {{ item.preco | number:'1.2-2' }}</span>
              </div>
            </div>
          </mat-card-content>

          <mat-menu #menu="matMenu" class="tavola-menu-bar" (menuClosed)="onMenuClosed($event)">
            <button mat-menu-item (click)="editar(item)">
              <mat-icon>edit</mat-icon>
              <span>Editar</span>
            </button>
            <button mat-menu-item (click)="confirmarRemocao(item)">
              <mat-icon>delete</mat-icon>
              <span>Remover</span>
            </button>
          </mat-menu>
        </mat-card>
      </div>
    </div>
  </ng-container>

  <!-- Estado de busca sem resultados -->
  <div *ngIf="!isLoading && itens.length > 0 && todasCategoriasFiltradasVazias && (pesquisa.trim() !== '' || categoriaFiltro !== '')" class="tavola-empty-search">
    <div class="empty-icon">
      <mat-icon>search_off</mat-icon>
    </div>
    <h3>Nenhum item encontrado</h3>
    <p *ngIf="pesquisa.trim() !== ''">Não encontramos nenhum item com "{{ pesquisa }}"</p>
    <p *ngIf="categoriaFiltro !== ''">Nenhum item encontrado na categoria "{{ categoriaFiltro }}"</p>
    <button mat-raised-button color="primary" (click)="limparPesquisa()">
      <mat-icon>refresh</mat-icon>
      Limpar filtros
    </button>
  </div>

  <!-- Added empty state when no items exist -->
  <div *ngIf="!isLoading && todasCategoriasVazias" class="tavola-empty-search">
    <div class="empty-icon">
      <mat-icon>restaurant_menu</mat-icon>
    </div>
    <h3>Nenhum item cadastrado</h3>
    <p>Comece adicionando itens ao seu cardápio para que seus clientes possam visualizá-los.</p>
    <button mat-raised-button color="primary" (click)="adicionar()">
      <mat-icon>add</mat-icon>
      Adicionar Primeiro Item
    </button>
  </div>
</div>