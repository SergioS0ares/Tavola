<!-- Template para o conteúdo do menu (reutilizado em desktop e mobile) -->
<ng-template #menuContent>
  <div class="sidebar-header">
    <img src="assets/png/LogoTavolaSimples.png" alt="Logo Tavola" class="logo" />
  </div>

  <nav class="menu" role="navigation" aria-label="Menu principal">
    <ng-container *ngIf="isCliente">
      <button 
        routerLink="/home" 
        routerLinkActive="active" 
        (click)="closeDrawer()"
        type="button"
        aria-label="Ir para página inicial">
        <mat-icon aria-hidden="true">home</mat-icon>
        <span>Início</span>
      </button>
      <button 
        routerLink="/historico" 
        routerLinkActive="active" 
        (click)="closeDrawer()"
        type="button"
        aria-label="Ver histórico de reservas">
        <mat-icon aria-hidden="true">history</mat-icon>
        <span>Histórico</span>
      </button>
      <button 
        routerLink="/favoritos" 
        routerLinkActive="active" 
        (click)="closeDrawer()"
        type="button"
        aria-label="Ver restaurantes favoritos">
        <mat-icon aria-hidden="true">favorite</mat-icon>
        <span>Favoritos</span>
      </button>
    </ng-container>

    <ng-container *ngIf="isRestaurante">
      <button 
        routerLink="/reserva" 
        routerLinkActive="active" 
        (click)="closeDrawer()"
        type="button"
        aria-label="Gerenciar reservas">
        <mat-icon aria-hidden="true">event_available</mat-icon>
        <span>Reservas</span>
      </button>
      <button 
        routerLink="/meu-restaurante" 
        routerLinkActive="active" 
        (click)="closeDrawer()"
        type="button"
        aria-label="Gerenciar meu restaurante">
        <mat-icon aria-hidden="true">restaurant_menu</mat-icon>
        <span>Meu Restaurante</span>
      </button>
      <button 
        routerLink="/cadastro-cardapio" 
        routerLinkActive="active" 
        (click)="closeDrawer()"
        type="button"
        aria-label="Gerenciar cardápio">
        <mat-icon aria-hidden="true">menu_book</mat-icon>
        <span>Cardápio</span>
      </button>
      <button 
        routerLink="/gerenciar-equipe" 
        routerLinkActive="active" 
        (click)="closeDrawer()"
        type="button"
        aria-label="Gerenciar equipa">
        <mat-icon aria-hidden="true">groups</mat-icon>
        <span>Minha Equipe</span>
      </button>
    </ng-container>

    <button 
      routerLink="/configuracoes" 
      routerLinkActive="active" 
      (click)="closeDrawer()"
      type="button"
      aria-label="Acessar configurações">
      <mat-icon aria-hidden="true">settings</mat-icon>
      <span>Configurações</span>
    </button>
  </nav>
</ng-template>

<div class="layout-container">
  <!-- Enhanced Toolbar/Header -->
  <header class="toolbar" role="banner">
    <!-- Menu toggle buttons -->
    <button 
      class="menu-toggle mobile-menu-toggle" 
      (click)="openDrawer()" 
      *ngIf="(isMobile$ | async)"
      type="button"
      aria-label="Abrir menu de navegação"
      [attr.aria-expanded]="isDrawerVisible">
      <!-- Melhorado ícone hamburguer com animação mais suave -->
      <mat-icon [class.rotated]="isDrawerVisible" aria-hidden="true">menu</mat-icon>
    </button>
    
    <button 
      class="menu-toggle" 
      (click)="toggleSidebar()" 
      *ngIf="!(isMobile$ | async)"
      type="button"
      aria-label="Alternar sidebar"
      [attr.aria-expanded]="sidebarAberta">
      <mat-icon aria-hidden="true">menu</mat-icon>
    </button>
    
    <!-- Enhanced Search bar -->
    <app-search-bar
      *ngIf="showStickySearchBar"
      [@searchBarAnim]
      [citySuggestions]="citySuggestions"
      [querySuggestions]="querySuggestions"
      [showCityDropdown]="showCityDropdown"
      [showQueryDropdown]="showQueryDropdown"
      [cityCtrl]="cityCtrl"
      [queryCtrl]="queryCtrl"
      (search)="onSearchSticky()"
      (cityInput)="onCityInputSticky($event)"
      (selectCity)="selectCitySticky($event)"
      (selectQuery)="selectQuerySticky($event)"
      (cityBlur)="onCityBlurSticky($event)"
      (filtrosClick)="abrirDialogFiltros()"
      class="toolbar-search-bar"
      [class.sidebar-fechada]="!sidebarAberta"
      role="search"
      aria-label="Buscar restaurantes">
    </app-search-bar>

    
    <div class="header-actions" style="display: flex; align-items: center; gap: 20px;"> 
      <div class="notifications" *ngIf="isCliente">
        <button 
          mat-icon-button 
          class="notification-btn" 
          [matMenuTriggerFor]="menuNotificacoes"
          type="button"
          aria-label="Ver notificações"
          [attr.aria-describedby]="temAvaliacoesPendentes ? 'notifications-badge' : null">
          <nz-badge 
            [nzDot]="temAvaliacoesPendentes" 
            [nzOffset]="[10, 0]"
            [attr.aria-label]="temAvaliacoesPendentes ? 'Há avaliações pendentes' : 'Sem notificações'">
            <!-- Ícone de sino específico para restaurante -->
            <mat-icon aria-hidden="true">notifications_active</mat-icon>
          </nz-badge>
        </button>
      
        <mat-menu #menuNotificacoes="matMenu" class="notification-dropdown">
          <div class="dropdown-header" (click)="$event.stopPropagation();">
            <div class="header-content">
              <div class="header-icon">
                <mat-icon>notifications</mat-icon>
              </div>
              <div class="header-text">
                <h4>Notificações</h4>
                <p>{{ avaliacoesPendentes.length }} avaliação(ões) aguardando</p>
              </div>
            </div>
          </div>

          <!-- Tabs de navegação -->
          <div>
            <button 
              class="tab-button" 
              [class.active]="activeTab === 'pendentes'"
              (click)="setActiveTab('pendentes')">
              <mat-icon>schedule</mat-icon>
              <span>Pendentes</span>
              <span class="badge" *ngIf="avaliacoesPendentes.length > 0">{{ avaliacoesPendentes.length }}</span>
            </button>
            <button 
              class="tab-button" 
              [class.active]="activeTab === 'lidas'"
              (click)="setActiveTab('lidas')">
              <mat-icon>check_circle</mat-icon>
              <span>Lidas</span>
            </button>
          </div>
      
          <div class="dropdown-content" role="list">
            <!-- Tab Pendentes -->
            <div *ngIf="activeTab === 'pendentes'" class="tab-content">
              <div *ngIf="carregandoAvaliacoes" class="loading-state" role="status" aria-live="polite">
                <div class="loading-spinner">
                  <mat-icon aria-hidden="true">hourglass_empty</mat-icon>
                </div>
                <span>Carregando avaliações...</span>
              </div>
              
              <div *ngIf="!carregandoAvaliacoes && !temAvaliacoesPendentes" class="empty-state">
                <div class="empty-icon">
                  <mat-icon aria-hidden="true">check_circle</mat-icon>
                </div>
                <h5>Tudo em dia!</h5>
                <p>Nenhuma avaliação pendente no momento.</p>
              </div>
        
              <ng-container *ngIf="!carregandoAvaliacoes && temAvaliacoesPendentes">
                <div class="avaliacoes-list">
                  <button 
                    *ngFor="let avaliacao of avaliacoesPendentes; trackBy: trackByAvaliacaoId" 
                    mat-menu-item
                    class="avaliacao-item"
                    (click)="abrirDialogoAvaliacao(avaliacao)"
                    type="button"
                    role="menuitem"
                    [attr.aria-label]="'Avaliar ' + avaliacao.nomeRestaurante + ' da visita em ' + formatarDataReserva(avaliacao.dataReserva)">
                    <div class="avaliacao-content">
                      <div class="restaurante-info">
                        <div class="restaurante-icon">
                          <mat-icon>restaurant</mat-icon>
                        </div>
                        <div class="restaurante-details">
                          <h5>{{ avaliacao.nomeRestaurante }}</h5>
                          <p class="data-visita">
                            <mat-icon>schedule</mat-icon>
                            Visita em {{ formatarDataReserva(avaliacao.dataReserva) }}
                          </p>
                        </div>
                      </div>
                      <div class="avaliacao-action">
                        <mat-icon>star_border</mat-icon>
                        <span>Avaliar</span>
                      </div>
                    </div>
                  </button>
                </div>
              </ng-container>
            </div>

            <!-- Tab Lidas -->
            <div *ngIf="activeTab === 'lidas'" class="tab-content">
              <div class="empty-state">
                <div class="empty-icon">
                  <mat-icon aria-hidden="true">inbox</mat-icon>
                </div>
                <h5>Nenhuma notificação lida</h5>
                <p>As avaliações que você responder aparecerão aqui.</p>
              </div>
            </div>
          </div>
        </mat-menu>
      </div>

      <!-- Enhanced User menu -->
      <div class="user-menu" [matMenuTriggerFor]="menu" role="button" tabindex="0" aria-label="Menu do usuário">
        <div class="user-info">
          <div class="avatar">
            <img [src]="userAvatar" [alt]="'Avatar de ' + userName">
          </div>
          <div class="user-details" *ngIf="!(isMobile$ | async)">
            <span class="user-name">{{ userName }}</span>
            <span class="user-type">{{ userType }}</span>
          </div>
        </div>
        <mat-icon *ngIf="!(isMobile$ | async)" aria-hidden="true">keyboard_arrow_down</mat-icon>
      </div>

      <mat-menu #menu="matMenu" class="user-dropdown">
        <button mat-menu-item routerLink="/configuracoes" type="button">
          <mat-icon aria-hidden="true">settings</mat-icon>
          <span>Configurações</span>
        </button>
        <button mat-menu-item (click)="logout()" type="button">
          <mat-icon aria-hidden="true">logout</mat-icon>
          <span>Sair</span>
        </button>
      </mat-menu>
    </div>
  </header>

  <!-- Main content wrapper -->
  <div class="main-wrapper">
    <!-- Enhanced Desktop Sidebar -->
    <aside 
      class="desktop-sidebar" 
      [class.fechada]="!sidebarAberta" 
      (click)="handleSidebarClick($event)" 
      *ngIf="!(isMobile$ | async)"
      role="navigation"
      aria-label="Menu lateral"
      [attr.aria-expanded]="sidebarAberta">
      <ng-container *ngTemplateOutlet="menuContent"></ng-container>
    </aside>

    <!-- Enhanced Content area with proper scroll -->
    <main class="content" role="main">
      <div class="router-container">
        <router-outlet (activate)="onOutletActivate($event)"></router-outlet>
      </div>
    </main>
  </div>
</div>

<!-- Enhanced Mobile Drawer -->
<nz-drawer
  [nzClosable]="false"
  [nzVisible]="isDrawerVisible"
  nzPlacement="left"
  (nzOnClose)="closeDrawer()"
  nzWidth="340px"
  class="mobile-drawer"
  [attr.aria-label]="'Menu de navegação ' + (isDrawerVisible ? 'aberto' : 'fechado')">
  <ng-container *nzDrawerContent>
    <nav class="mobile-sidebar" role="navigation" aria-label="Menu de navegação mobile">
      <ng-container *ngTemplateOutlet="menuContent"></ng-container>
    </nav>
  </ng-container>
</nz-drawer>