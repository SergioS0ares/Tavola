<!-- Template para o conteúdo do menu (reutilizado em desktop e mobile) -->
<ng-template #menuContent>
  <div class="sidebar-header">
    <img src="assets/png/LogoTavolaSimples.png" alt="Logo Tavola" class="logo" />
  </div>

  <nav class="menu" role="navigation" aria-label="Menu principal">
    <ng-container *ngIf="isCliente">
      <button 
        routerLink="/home" 
        routerLinkActive="active" 
        (click)="closeDrawer()"
        type="button"
        aria-label="Ir para página inicial">
        <mat-icon aria-hidden="true">home</mat-icon>
        <span>Início</span>
      </button>
      <button 
        routerLink="/historico" 
        routerLinkActive="active" 
        (click)="closeDrawer()"
        type="button"
        aria-label="Ver histórico de reservas">
        <mat-icon aria-hidden="true">history</mat-icon>
        <span>Histórico</span>
      </button>
      <button 
        routerLink="/favoritos" 
        routerLinkActive="active" 
        (click)="closeDrawer()"
        type="button"
        aria-label="Ver restaurantes favoritos">
        <mat-icon aria-hidden="true">favorite</mat-icon>
        <span>Favoritos</span>
      </button>
    </ng-container>

    <ng-container *ngIf="isRestaurante">
      <button 
        routerLink="/reserva" 
        routerLinkActive="active" 
        (click)="closeDrawer()"
        type="button"
        aria-label="Gerenciar reservas">
        <mat-icon aria-hidden="true">event_available</mat-icon>
        <span>Reservas</span>
      </button>
      <button 
        routerLink="/meu-restaurante" 
        routerLinkActive="active" 
        (click)="closeDrawer()"
        type="button"
        aria-label="Gerenciar meu restaurante">
        <mat-icon aria-hidden="true">restaurant_menu</mat-icon>
        <span>Meu Restaurante</span>
      </button>
      <button 
        routerLink="/cadastro-cardapio" 
        routerLinkActive="active" 
        (click)="closeDrawer()"
        type="button"
        aria-label="Gerenciar cardápio">
        <mat-icon aria-hidden="true">menu_book</mat-icon>
        <span>Cardápio</span>
      </button>
      <button 
        routerLink="/gerenciar-equipe" 
        routerLinkActive="active" 
        (click)="closeDrawer()"
        type="button"
        aria-label="Gerenciar equipa">
        <mat-icon aria-hidden="true">groups</mat-icon>
        <span>Minha Equipe</span>
      </button>
    </ng-container>

    <ng-container *ngIf="isFuncionario">
      <button 
        routerLink="/painel-garcom" 
        routerLinkActive="active" 
        (click)="closeDrawer()"
        type="button"
        aria-label="Painel do garçom">
        <mat-icon aria-hidden="true">restaurant_menu</mat-icon>
        <span>Painel Garçom</span>
      </button>
    </ng-container>

    <button 
      routerLink="/configuracoes" 
      routerLinkActive="active" 
      (click)="closeDrawer()"
      type="button"
      aria-label="Acessar configurações"
      class="config-button"
      *ngIf="!isFuncionario">
      <mat-icon aria-hidden="true">settings</mat-icon>
      <span>Configurações</span>
    </button>
  </nav>
</ng-template>

<div class="layout-container">
  <!-- Enhanced Toolbar/Header -->
  <header class="toolbar" [class.home-page]="router.url.startsWith('/home')" role="banner">
    <!-- Menu toggle buttons -->
    <button 
      class="menu-toggle mobile-menu-toggle" 
      (click)="openDrawer()" 
      *ngIf="(isMobile$ | async) && !searchExpanded"
      type="button"
      aria-label="Abrir menu de navegação"
      [attr.aria-expanded]="isDrawerVisible">
      <mat-icon [class.rotated]="isDrawerVisible" aria-hidden="true">menu</mat-icon>
    </button>
    
    <button 
      class="menu-toggle" 
      (click)="toggleSidebar()" 
      *ngIf="!(isMobile$ | async) && !searchExpanded"
      type="button"
      aria-label="Alternar sidebar"
      [attr.aria-expanded]="sidebarAberta">
      <mat-icon aria-hidden="true">menu</mat-icon>
    </button>
    
    <!-- Expanded search container (GitHub/99 Food style) -->
    <!-- Aparece quando o search está expandido, independente de estar na home ou não -->
    <div class="expanded-search-container" *ngIf="searchExpanded">
      <!-- City chip -->
      <button class="city-chip" (click)="openCitySelector()" type="button">
        <mat-icon>location_on</mat-icon>
        <span>{{ cidadeSelecionada }}</span>
        <mat-icon class="dropdown-icon">arrow_drop_down</mat-icon>
      </button>

      <!-- Divider -->
      <div class="search-divider"></div>

      <!-- Main search input -->
      <input 
        class="search-input" 
        placeholder="Busque por prato ou restaurante..." 
        [formControl]="queryCtrl" 
        (keyup.enter)="onSearchSticky()"
        type="text">

      <!-- Filter button -->
      <button 
        class="filter-button" 
        (click)="abrirDialogFiltros()"
        type="button"
        aria-label="Abrir filtros">
        <mat-icon>tune</mat-icon>
      </button>

      <!-- Close button -->
      <button 
        class="close-search-button" 
        (click)="collapseSearch()"
        type="button"
        aria-label="Fechar busca">
        <mat-icon>close</mat-icon>
      </button>

      <!-- City dropdown for city selection -->
      <div class="city-dropdown-expanded" *ngIf="showCityDropdown" (click)="$event.stopPropagation()">
        <div class="dropdown-header">
          <mat-icon>location_on</mat-icon>
          <span>Selecione a cidade</span>
        </div>
        <div class="dropdown-item" (click)="selectCitySticky('Perto de mim'); showCityDropdown = false">
          <mat-icon>my_location</mat-icon>
          <span>Perto de mim</span>
        </div>
        <div class="dropdown-divider"></div>
        <div class="dropdown-title">Sugestões</div>
        <div 
          class="dropdown-item" 
          *ngFor="let city of citySuggestions.slice(0, 5)" 
          (click)="selectCitySticky(city); showCityDropdown = false">
          <mat-icon>location_on</mat-icon>
          <span>{{ city }}</span>
        </div>
      </div>
    </div>
    
    <!-- Hide header actions when search is expanded on mobile -->
    <div class="header-actions" *ngIf="!searchExpanded" style="display: flex; align-items: center; gap: 20px;"> 
      <!-- Search icon button when sticky and not expanded - positioned next to bell -->
      <!-- Aparece na home ou agendamento quando a search bar da home ESTÁ sticky (ou seja, quando sumiu da home e foi para o topo) -->
      <button 
        class="search-icon-btn" 
        *ngIf="(isHomePage || isAgendamentoPage) && showStickySearchBar && !searchExpanded"
        (click)="expandSearch()"
        type="button"
        aria-label="Expandir busca">
        <mat-icon>search</mat-icon>
      </button>

      <div class="notifications" *ngIf="isCliente">
        <button 
          mat-icon-button 
          class="notification-btn" 
          [matMenuTriggerFor]="menuNotificacoes"
          #notificationMenuTrigger="matMenuTrigger"
          type="button"
          aria-label="Ver notificações"
          [attr.aria-describedby]="temAvaliacoesPendentes ? 'notifications-badge' : null">
          <nz-badge 
            [nzDot]="temAvaliacoesPendentes" 
            [nzOffset]="[10, 0]"
            [attr.aria-label]="temAvaliacoesPendentes ? 'Há avaliações pendentes' : 'Sem notificações'">
            <!-- Ícone de sino específico para restaurante -->
            <mat-icon aria-hidden="true">notifications_active</mat-icon>
          </nz-badge>
        </button>
      
        <mat-menu #menuNotificacoes="matMenu" class="user-dropdown notifications-menu" xPosition="before" yPosition="below" (menuClosed)="onMenuClosed($event)">
          <!-- Botão X para fechar no mobile -->
          <button mat-menu-item (click)="notificationMenuTrigger.closeMenu()" type="button" class="close-menu-mobile" *ngIf="(isMobile$ | async)">
            <mat-icon aria-hidden="true">close</mat-icon>
            <span>Fechar</span>
          </button>
          <!-- Estado de carregamento -->
          <div *ngIf="carregandoAvaliacoes" class="notifications-loading">
            <mat-icon>hourglass_empty</mat-icon>
            <span>Carregando avaliações...</span>
          </div>
          
          <!-- Estado vazio -->
          <div *ngIf="!carregandoAvaliacoes && !temAvaliacoesPendentes" class="notifications-empty">
            <mat-icon>check_circle</mat-icon>
            <span>Tudo em dia!</span>
            <p>Nenhuma avaliação pendente no momento.</p>
          </div>
      
          <!-- Lista de avaliações pendentes -->
          <ng-container *ngIf="!carregandoAvaliacoes && temAvaliacoesPendentes">
            <button 
              *ngFor="let avaliacao of avaliacoesPendentes; trackBy: trackByAvaliacaoId" 
              mat-menu-item
              (click)="abrirDialogoAvaliacao(avaliacao)"
              type="button"
              role="menuitem"
              class="notification-item"
              [attr.aria-label]="'Avaliar ' + avaliacao.nomeRestaurante + ' da visita em ' + formatarDataReserva(avaliacao.dataReserva)">
              <mat-icon>restaurant</mat-icon>
              <div class="notification-content">
                <span class="notification-title">{{ avaliacao.nomeRestaurante }}</span>
                <span class="notification-date">{{ formatarDataReserva(avaliacao.dataReserva) }}</span>
              </div>
            </button>
          </ng-container>
        </mat-menu>
      </div>

      <!-- Enhanced User menu -->
      <div class="user-menu" [matMenuTriggerFor]="menu" #userMenuTrigger="matMenuTrigger" (menuOpened)="onMenuOpened(userMenuTrigger)" role="button" tabindex="0" aria-label="Menu do usuário" *ngIf="!(isMobile$ | async)">
        <div class="user-info">
          <div class="avatar">
            <img [src]="userAvatar" [alt]="'Avatar de ' + userName">
          </div>
          <div class="user-details">
            <span class="user-name">{{ userName }}</span>
            <span class="user-type">{{ userType === 'FUNCIONARIO' ? 'Funcionário' : userType }}</span>
          </div>
        </div>
        <mat-icon aria-hidden="true">keyboard_arrow_down</mat-icon>
      </div>

      <!-- Mobile User Avatar - simplified without menu trigger -->
      <div class="user-avatar-mobile" *ngIf="(isMobile$ | async)" [matMenuTriggerFor]="menu" #userMenuTriggerMobile="matMenuTrigger" (menuOpened)="onMenuOpened(userMenuTriggerMobile)" role="button" tabindex="0" aria-label="Menu do usuário">
        <div class="avatar-mobile">
          <img [src]="userAvatar" [alt]="'Avatar de ' + userName">
        </div>
      </div>

      <mat-menu #menu="matMenu" class="user-dropdown" xPosition="before" yPosition="below" (menuClosed)="onMenuClosed($event)">
        <!-- Botão X para fechar no mobile -->
        <button mat-menu-item (click)="fecharMenuUsuario()" type="button" class="close-menu-mobile" *ngIf="(isMobile$ | async)">
          <mat-icon aria-hidden="true">close</mat-icon>
          <span>Fechar</span>
        </button>
        <button mat-menu-item routerLink="/configuracoes" type="button" *ngIf="!isFuncionario">
          <mat-icon aria-hidden="true">settings</mat-icon>
          <span>Configurações</span>
        </button>
        <button mat-menu-item (click)="logout()" type="button">
          <mat-icon aria-hidden="true">logout</mat-icon>
          <span>Sair</span>
        </button>
      </mat-menu>
    </div>
  </header>

  <!-- Main content wrapper -->
  <div class="main-wrapper" [class.home-page]="router.url.startsWith('/home')">
    <!-- Enhanced Desktop Sidebar -->
    <aside 
      class="desktop-sidebar" 
      [class.fechada]="!sidebarAberta" 
      (click)="handleSidebarClick($event)" 
      *ngIf="!(isMobile$ | async)"
      role="navigation"
      aria-label="Menu lateral"
      [attr.aria-expanded]="sidebarAberta">
      <ng-container *ngTemplateOutlet="menuContent"></ng-container>
    </aside>

    <!-- Enhanced Content area with proper scroll -->
    <main class="content" role="main">
      <div class="router-container" [class.home-padding]="isHomePage">
        <router-outlet (activate)="onOutletActivate($event)"></router-outlet>
      </div>
    </main>
  </div>
</div>

<!-- Enhanced Mobile Drawer -->
<nz-drawer
  [nzClosable]="false"
  [nzVisible]="isDrawerVisible"
  nzPlacement="left"
  (nzOnClose)="closeDrawer()"
  [nzWidth]="(isMobile$ | async) ? '75%' : '340px'"
  class="mobile-drawer"
  [attr.aria-label]="'Menu de navegação ' + (isDrawerVisible ? 'aberto' : 'fechado')">
  <ng-container *nzDrawerContent>
    <nav class="mobile-sidebar" role="navigation" aria-label="Menu de navegação mobile">
      <ng-container *ngTemplateOutlet="menuContent"></ng-container>
    </nav>
  </ng-container>
</nz-drawer>
