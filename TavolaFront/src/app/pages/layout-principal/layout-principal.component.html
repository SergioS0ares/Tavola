<!-- Template para o conteúdo do menu (reutilizado em desktop e mobile) -->
<ng-template #menuContent>
  <div class="sidebar-header">
    <img src="assets/png/LogoTavolaSimples.png" alt="Logo Tavola" class="logo" />
  </div>

  <div class="menu">
    <ng-container *ngIf="isCliente">
      <button routerLink="/home" routerLinkActive="active" (click)="closeDrawer()">
        <mat-icon>home</mat-icon>
        <span>Início</span>
      </button>
      <button routerLink="/historico" routerLinkActive="active" (click)="closeDrawer()">
        <mat-icon>history</mat-icon>
        <span>Histórico</span>
      </button>
    </ng-container>

    <ng-container *ngIf="isRestaurante">
      <button routerLink="/reserva" routerLinkActive="active" (click)="closeDrawer()">
        <mat-icon>event</mat-icon>
        <span>Reservas</span>
      </button>
      <button routerLink="/meu-restaurante" routerLinkActive="active" (click)="closeDrawer()">
        <mat-icon>restaurant</mat-icon>
        <span>Meu Restaurante</span>
      </button>
      <button routerLink="/cadastro-cardapio" routerLinkActive="active" (click)="closeDrawer()">
        <mat-icon>menu_book</mat-icon>
        <span>Cardápio</span>
      </button>
    </ng-container>

    <button routerLink="/configuracoes" routerLinkActive="active" (click)="closeDrawer()">
      <mat-icon>settings</mat-icon>
      <span>Configurações</span>
    </button>
  </div>
</ng-template>

<div class="layout-container">
  <!-- Sidebar para Desktop -->
  <div class="sidebar desktop-sidebar" [class.fechada]="!sidebarAberta" (click)="handleSidebarClick($event)" *ngIf="!(isMobile$ | async)">
    <ng-container *ngTemplateOutlet="menuContent"></ng-container>
  </div>

  <!-- Conteúdo Principal -->
  <div class="main-wrapper">
    <!-- Toolbar/Header -->
    <div class="toolbar">
      <!-- Botão hambúrguer para mobile -->
      <button 
        class="menu-toggle mobile-menu-toggle" 
        (click)="openDrawer()" 
        *ngIf="(isMobile$ | async)">
        <mat-icon [class.rotated]="isDrawerVisible">menu</mat-icon>
      </button>
      
      <!-- Botão toggle para desktop -->
      <button class="menu-toggle" (click)="toggleSidebar()" *ngIf="!(isMobile$ | async)">
        <mat-icon>menu</mat-icon>
      </button>
      
      <app-search-bar
        *ngIf="showStickySearchBar"
        [@searchBarAnim]
        [citySuggestions]="citySuggestions"
        [querySuggestions]="querySuggestions"
        [showCityDropdown]="showCityDropdown"
        [showQueryDropdown]="showQueryDropdown"
        [cityCtrl]="cityCtrl"
        [queryCtrl]="queryCtrl"
        (search)="onSearchSticky()"
        (cityInput)="onCityInputSticky($event)"
        (selectCity)="selectCitySticky($event)"
        (selectQuery)="selectQuerySticky($event)"
        (cityBlur)="onCityBlurSticky($event)"
        class="toolbar-search-bar"
      ></app-search-bar>

      <!-- Ícone de notificações para clientes -->
      <div class="notifications" *ngIf="isCliente">
  
        <button mat-icon-button class="notification-btn" [matMenuTriggerFor]="menuNotificacoes">
          <nz-badge [nzDot]="temAvaliacoesPendentes" [nzOffset]="[8, 0]">
            <mat-icon>notifications</mat-icon>
          </nz-badge>
        </button>
      
        <mat-menu #menuNotificacoes="matMenu" class="notification-dropdown">
          
          <div class="dropdown-header" (click)="$event.stopPropagation();">
            <h4>Avaliações Pendentes</h4>
          </div>
      
          <div class="dropdown-content">
            <div *ngIf="carregandoAvaliacoes" class="loading-state">
              <mat-icon>hourglass_empty</mat-icon>
              <span>Carregando...</span>
            </div>
            <div *ngIf="!carregandoAvaliacoes && !temAvaliacoesPendentes" class="empty-state">
              <mat-icon>check_circle</mat-icon>
              <span>Nenhuma avaliação pendente</span>
            </div>
      
            <ng-container *ngIf="!carregandoAvaliacoes && temAvaliacoesPendentes">
              <button 
                *ngFor="let avaliacao of avaliacoesPendentes" 
                mat-menu-item
                class="avaliacao-item"
                (click)="abrirDialogoAvaliacao(avaliacao)">
                <div class="avaliacao-content">
                  <h5>{{ avaliacao.nomeRestaurante }}</h5>
                  <p>Avalie sua visita em {{ formatarDataReserva(avaliacao.dataReserva) }}</p>
                </div>
                <mat-icon>star_border</mat-icon>
              </button>
            </ng-container>
          </div>
      
        </mat-menu>
      </div>

      <div class="user-menu" [matMenuTriggerFor]="menu">
        <div class="user-info">
          <div class="avatar">
            <img [src]="userAvatar" alt="Avatar do usuário">
          </div>
          <div class="user-details" *ngIf="!(isMobile$ | async)">
            <span class="user-name">{{ userName }}</span>
            <span class="user-type">{{ userType }}</span>
          </div>
        </div>
        <mat-icon *ngIf="!(isMobile$ | async)">keyboard_arrow_down</mat-icon>
      </div>

      <mat-menu #menu="matMenu" class="user-dropdown">
        <button mat-menu-item routerLink="/configuracoes">
          <mat-icon>settings</mat-icon>
          <span>Configurações</span>
        </button>
        <button mat-menu-item (click)="logout()">
          <mat-icon>logout</mat-icon>
          <span>Sair</span>
        </button>
      </mat-menu>
    </div>

    <!-- Conteúdo da página -->
    <div class="content">
      <div class="router-container">
        <router-outlet (activate)="onOutletActivate($event)"></router-outlet>
      </div>
    </div>
  </div>
</div>

<!-- Drawer para Mobile -->
<nz-drawer
  [nzClosable]="false"
  [nzVisible]="isDrawerVisible"
  nzPlacement="left"
  (nzOnClose)="closeDrawer()"
  nzWidth="280px"
  class="mobile-drawer">
  <ng-container *nzDrawerContent>
    <div class="mobile-sidebar">
      <ng-container *ngTemplateOutlet="menuContent"></ng-container>
    </div>
  </ng-container>
</nz-drawer>