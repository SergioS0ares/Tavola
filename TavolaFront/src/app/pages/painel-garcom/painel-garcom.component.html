<div class="painel-garcom-container">
  <!-- Page Header -->
  <div class="tavola-page-header garcom">
    <div class="header-content">
      <div class="header-icon">
        <mat-icon>restaurant_menu</mat-icon>
      </div>
      <div class="header-text">
        <h1>Painel do Garçom</h1>
        <p>Gerencie o atendimento das mesas e acompanhe os pedidos em tempo real.</p>
      </div>
    </div>
  </div>

  <!-- Informações do Garçom -->
  <div class="garcom-info-card">
    <div class="garcom-avatar">
      <nz-avatar [nzSize]="64" [nzSrc]="garcomInfo.foto || 'assets/png/avatar-padrao-garcom-tavola.png'" nzIcon="person"></nz-avatar>
    </div>
    <div class="garcom-details">
      <h3>{{ garcomInfo.nome || 'Garçom' }}</h3>
      <p>{{ garcomInfo.turno || 'Turno Atual' }}</p>
      <div class="garcom-stats">
        <div class="stat-item">
          <mat-icon>table_restaurant</mat-icon>
          <span>{{ mesasAtendidas }} Mesa(s)</span>
        </div>
        </div>
      </div>
  </div>

  <!-- Seletor de Visualização Mobile -->
  <div class="view-switcher" *ngIf="isMobile">
    <mat-button-toggle-group [(value)]="visualizacaoAtiva" (change)="onViewChange($event)">
      <mat-button-toggle value="mapa">
        <mat-icon>map</mat-icon>
        <span>Mapa</span>
      </mat-button-toggle>
      <mat-button-toggle value="pedidos">
        <mat-icon>receipt</mat-icon>
        <span>Pedidos</span>
      </mat-button-toggle>
    </mat-button-toggle-group>
  </div>

  <!-- Navegador de Data Mobile -->
  <div class="date-navigator-area" *ngIf="isMobile">
    <div class="date-navigator">
      <button mat-icon-button (click)="diaAnterior()" aria-label="Dia anterior">
        <mat-icon>chevron_left</mat-icon>
      </button>
      <nz-date-picker
        nzFormat="dd/MM/yyyy"
        [(ngModel)]="dataAtual"
        (ngModelChange)="nzDatePickerChange($event)"
        nzAllowClear="false"
      ></nz-date-picker>
      <button mat-icon-button (click)="proximoDia()" aria-label="Próximo dia">
        <mat-icon>chevron_right</mat-icon>
      </button>
      <button mat-icon-button (click)="abrirCalendario()" class="calendario-btn" matTooltip="Ver calendário de reservas" matTooltipClass="tavola-tooltip" [matTooltipDisabled]="isMobile">
        <mat-icon>calendar_month</mat-icon>
      </button>
    </div>
  </div>

  <div class="painel-content-columns">
    <!-- Mapa de Mesas -->
    <div class="mapa-mesas-column" *ngIf="visualizacaoAtiva === 'mapa' || !isMobile">
      <div *ngIf="(ambientes$ | async) as ambientes">
        <!-- Navegador de Data Desktop -->
        <div class="date-navigator-area" *ngIf="!isMobile">
          <div class="date-navigator">
            <button mat-icon-button (click)="diaAnterior()" aria-label="Dia anterior">
              <mat-icon>chevron_left</mat-icon>
            </button>
            <nz-date-picker
              nzFormat="dd/MM/yyyy"
              [(ngModel)]="dataAtual"
              (ngModelChange)="nzDatePickerChange($event)"
              nzAllowClear="false"
            ></nz-date-picker>
            <button mat-icon-button (click)="proximoDia()" aria-label="Próximo dia">
              <mat-icon>chevron_right</mat-icon>
            </button>
            <button mat-icon-button (click)="abrirCalendario()" class="calendario-btn" matTooltip="Ver calendário de reservas" matTooltipClass="tavola-tooltip" [matTooltipDisabled]="isMobile">
              <mat-icon>calendar_month</mat-icon>
            </button>
          </div>
        </div>

      <!-- Legenda de Status das Mesas -->
      <div class="legenda-mesas">
        <div class="legenda-item" [class]="getClasseFiltroStatus(null)" (click)="filtrarMesasPorStatus(null)">
          <span class="indicador-cor" [style.background]="'#666666'"></span>
          <mat-icon class="legenda-icon">apps</mat-icon>
          Todas as Mesas
        </div>
        <div class="legenda-item" [class]="getClasseFiltroStatus('LIVRE')" (click)="filtrarMesasPorStatus('LIVRE')">
          <span class="indicador-cor" [style.background]="'#4CAF50'"></span>
          <mat-icon class="legenda-icon">event_available</mat-icon>
          Mesa Livre
        </div>
        <div class="legenda-item" [class]="getClasseFiltroStatus('OCUPADA')" (click)="filtrarMesasPorStatus('OCUPADA')">
          <span class="indicador-cor" [style.background]="'#F44336'"></span>
          <mat-icon class="legenda-icon">person</mat-icon>
          Mesa Ocupada (Avulso)
        </div>
        <div class="legenda-item" [class]="getClasseFiltroStatus('RESERVADA')" (click)="filtrarMesasPorStatus('RESERVADA')">
          <span class="indicador-cor" [style.background]="'#2196F3'"></span>
          <mat-icon class="legenda-icon">event</mat-icon>
          Mesa Reservada
        </div>
        <div class="legenda-item" [class]="getClasseFiltroStatus('EM_ATENDIMENTO')" (click)="filtrarMesasPorStatus('EM_ATENDIMENTO')">
          <span class="indicador-cor" [style.background]="'#F6BD38'"></span>
          <mat-icon class="legenda-icon">restaurant</mat-icon>
          Em Atendimento
        </div>
      </div>

      <div class="mesas-container">
        <!-- HEADER COM AS ABAS DE AMBIENTE -->
        <div class="areas-header">
          
          <div class="ambientes-nav-wrapper">
            <!-- Setas de navegação -->
            <button mat-icon-button class="nav-arrow left-arrow" *ngIf="mostrarSetaEsquerda" (click)="scrollAmbientes('left')">
              <mat-icon>chevron_left</mat-icon>
            </button>
            
            <div class="ambientes-scroll-container" #ambientesScroll (scroll)="verificarVisibilidadeSetas()">
              <div class="ambientes-list">
                <div 
                  *ngFor="let ambiente of (ambientes$ | async); let i = index" 
                  class="ambiente-btn-wrapper custom-tab-label" 
                  [class.active]="ambiente.id === ambienteAtivo?.id">
                  
                  <button class="ambiente-btn" (click)="selecionarAmbiente(ambiente)">
                    <span>{{ ambiente.nome }}</span>
                  </button>
                </div>
                </div>
              </div>
            
            <button mat-icon-button class="nav-arrow right-arrow" *ngIf="mostrarSetaDireita" (click)="scrollAmbientes('right')">
              <mat-icon>chevron_right</mat-icon>
              </button>
        </div>
      </div>

        <!-- Grid de mesas -->
        <div class="mesas-grid-container" *ngIf="ambienteAtivo">
          <div class="mesas-grid-css">
            <ng-container *ngFor="let mesa of ambienteAtivo.mesas">
              <div *ngIf="deveExibirMesa(mesa)" class="mesa-wrapper-css">
                  <div 
                    class="mesa" 
                    [ngClass]="{ 
                      'mesa-ocupada': mesa.status === 'OCUPADA', 
                      'mesa-reservada': mesa.status === 'RESERVADA',
                      'mesa-em-atendimento': mesa.status === 'EM_ATENDIMENTO',
                      'mesa-livre': mesa.status === 'LIVRE'
                    }" 
                    (click)="selecionarMesa(mesa)"
                    [matTooltip]="getTooltipMesa(mesa)" 
                    matTooltipClass="tavola-tooltip"
                    [matTooltipDisabled]="isMobile">
                    
                    <div class="mesa-visual" [ngClass]="{'mesa-circular': mesa.tipo === 'circular'}">
                      <!-- Indicador de status no canto superior esquerdo -->
                      <mat-icon 
                        *ngIf="mesa.status !== 'LIVRE'" 
                        class="status-indicator-icon">
                        {{ getStatusIcon(mesa.status) }}
                      </mat-icon>
                      
                      <span class="mesa-capacidade">
                        {{ mesa.capacidade }}
                        <mat-icon class="person-icon">person</mat-icon>
                      </span>
                      
                      <!-- Tempo de ocupação abaixo da capacidade -->
                      <div class="tempo-ocupacao-overlay" *ngIf="(mesa.status === 'OCUPADA' || mesa.status === 'EM_ATENDIMENTO') && mesa.tempoOcupacaoDisplay">
                        <span>{{ mesa.tempoOcupacaoDisplay }}</span>
                      </div>
                      
                      <!-- Overlay dos garçons no canto inferior direito -->
                      <div class="garcons-overlay" *ngIf="getGarcomsAtendendoMesa(mesa.id).length > 0">
                        <div *ngFor="let garcom of getGarcomsAtendendoMesa(mesa.id) | slice:0:2" 
                             class="avatar-garcom" 
                             [matTooltip]="garcom.nome" 
                             matTooltipClass="tavola-tooltip"
                             [matTooltipDisabled]="isMobile">
                          <img *ngIf="garcom.foto" [src]="garcom.foto" [alt]="garcom.nome"/>
                          <span *ngIf="!garcom.foto">{{ garcom.nome.substring(0,1) }}</span>
                        </div>
                        <div *ngIf="getGarcomsAtendendoMesa(mesa.id).length > 2" 
                             class="avatar-garcom mais-garcons" 
                             [matTooltip]="getNomesGarconsExtras(mesa.id)" 
                             matTooltipClass="tavola-tooltip"
                             [matTooltipDisabled]="isMobile">
                          +{{ getGarcomsAtendendoMesa(mesa.id).length - 2 }}
                        </div>
                      </div>
                    </div>
                    
                    <div class="mesa-etiqueta" [ngClass]="{'mesa-vip': mesa.vip}">
                      <nz-icon *ngIf="mesa.vip" nzType="crown" nzTheme="outline" class="vip-icon"></nz-icon>
                      <span>{{ mesa.nome }}</span>
                    </div>
                  </div>
                </div>
              </ng-container>
          </div>
        </div>
        
        <div *ngIf="!ambienteAtivo && !isLoading.ambientes && (ambientes$ | async)?.length === 0" class="empty-state">
          <nz-empty nzNotFoundContent="Nenhum ambiente encontrado."></nz-empty>
        </div>

        <div *ngIf="isLoading.ambientes" class="loading-state">
          <mat-progress-spinner diameter="50"></mat-progress-spinner>
        </div>
      </div>
      </div>
    </div>

    <!-- Painel de Pedidos -->
    <div class="pedidos-column" *ngIf="visualizacaoAtiva === 'pedidos' || !isMobile">
      <div class="pedidos-header">
        <h3>Pedidos Ativos</h3>
        <div class="header-actions">
          <button mat-stroked-button (click)="atualizarPedidos()" class="refresh-btn">
            <mat-icon>refresh</mat-icon>
            <span class="btn-text">Atualizar</span>
          </button>
        </div>
      </div>
      
      <div class="pedidos-list">
        <div *ngFor="let pedido of (pedidosAtivos$ | async)" class="pedido-card">
          <div class="pedido-header">
            <div class="mesa-info">
              <mat-icon>table_restaurant</mat-icon>
              <span>Mesa {{ pedido.mesaNome }}</span>
            </div>
            <div class="pedido-status" [ngClass]="'status-' + pedido.status.toLowerCase()">
              {{ pedido.status }}
            </div>
          </div>
          
          <div class="pedido-itens">
            <div *ngFor="let item of pedido.itens" class="pedido-item">
              <span class="item-quantidade">{{ item.quantidade }}x</span>
              <span class="item-nome">{{ item.nome }}</span>
              <span class="item-preco">{{ item.preco | currency:'BRL' }}</span>
            </div>
          </div>
          
          <div class="pedido-total">
            <strong>Total: {{ calcularTotalPedido(pedido) | currency:'BRL' }}</strong>
          </div>
              
          <div class="pedido-actions">
            <button mat-stroked-button (click)="editarPedido(pedido)" class="edit-btn">
              <mat-icon>edit</mat-icon>
              <span class="btn-text">Editar</span>
            </button>
            <button mat-stroked-button (click)="removerPedido(pedido)" class="remove-btn">
              <mat-icon>delete</mat-icon>
              <span class="btn-text">Remover</span>
            </button>
          </div>
        </div>
        
        <div *ngIf="(pedidosAtivos$ | async)?.length === 0" class="sem-pedidos">
          <nz-empty nzDescription="Nenhum pedido ativo no momento"></nz-empty>
        </div>
      </div>
    </div>
  </div>

</div>