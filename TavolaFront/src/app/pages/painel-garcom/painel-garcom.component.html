<div class="painel-garcom-container">
  <!-- Page Header -->
  <div class="tavola-page-header garcom">
    <div class="header-content">
      <div class="header-icon">
        <mat-icon>restaurant_menu</mat-icon>
      </div>
      <div class="header-text">
        <h1>Painel do Garçom</h1>
        <p>Gerencie o atendimento das mesas e acompanhe os pedidos em tempo real.</p>
      </div>
    </div>
  </div>

  <!-- Informações do Garçom -->
  <div class="garcom-info-card">
    <div class="garcom-avatar">
      <nz-avatar [nzSize]="64" [nzSrc]="garcomInfo.foto || 'assets/png/avatar-padrao-garcom-tavola.png'" nzIcon="person"></nz-avatar>
    </div>
    <div class="garcom-details">
      <h3>{{ garcomInfo.nome || 'Garçom' }}</h3>
      <p>{{ garcomInfo.turno || 'Turno Atual' }}</p>
      <div class="garcom-stats">
        <div class="stat-item">
          <mat-icon>table_restaurant</mat-icon>
          <span>{{ mesasAtendidas }} Mesa(s)</span>
        </div>
        <div class="stat-item">
          <mat-icon>schedule</mat-icon>
          <span>{{ tempoTrabalho }}</span>
        </div>
        </div>
      </div>
    <div class="garcom-actions">
      <button mat-stroked-button (click)="finalizarTurno()" [disabled]="mesasAtendidas > 0">
        <mat-icon>logout</mat-icon>
        Finalizar Turno
      </button>
    </div>
  </div>

  <!-- Seletor de Visualização Mobile -->
  <div class="view-switcher" *ngIf="isMobile">
    <mat-button-toggle-group [(value)]="visualizacaoAtiva" (change)="onViewChange($event)">
      <mat-button-toggle value="mapa">
        <mat-icon>map</mat-icon>
        <span>Mapa</span>
      </mat-button-toggle>
      <mat-button-toggle value="pedidos">
        <mat-icon>receipt</mat-icon>
        <span>Pedidos</span>
      </mat-button-toggle>
    </mat-button-toggle-group>
  </div>

  <!-- Navegador de Data Mobile -->
  <div class="date-navigator-area" *ngIf="isMobile">
    <div class="date-navigator">
      <button mat-icon-button (click)="diaAnterior()" aria-label="Dia anterior">
        <mat-icon>chevron_left</mat-icon>
      </button>
      <nz-date-picker
        nzFormat="dd/MM/yyyy"
        [(ngModel)]="dataAtual"
        (ngModelChange)="nzDatePickerChange($event)"
        nzAllowClear="false"
      ></nz-date-picker>
      <button mat-icon-button (click)="proximoDia()" aria-label="Próximo dia">
        <mat-icon>chevron_right</mat-icon>
      </button>
      <button mat-icon-button (click)="abrirCalendario()" class="calendario-btn" matTooltip="Ver calendário de reservas" matTooltipClass="tavola-tooltip">
        <mat-icon>calendar_month</mat-icon>
      </button>
    </div>
  </div>

  <div class="painel-content-columns">
    <!-- Mapa de Mesas -->
    <div class="mapa-mesas-column" *ngIf="visualizacaoAtiva === 'mapa' || !isMobile">
      <!-- Navegador de Data Desktop -->
      <div class="date-navigator-area" *ngIf="!isMobile">
        <div class="date-navigator">
          <button mat-icon-button (click)="diaAnterior()" aria-label="Dia anterior">
            <mat-icon>chevron_left</mat-icon>
          </button>
          <nz-date-picker
            nzFormat="dd/MM/yyyy"
            [(ngModel)]="dataAtual"
            (ngModelChange)="nzDatePickerChange($event)"
            nzAllowClear="false"
          ></nz-date-picker>
          <button mat-icon-button (click)="proximoDia()" aria-label="Próximo dia">
            <mat-icon>chevron_right</mat-icon>
          </button>
          <button mat-icon-button (click)="abrirCalendario()" class="calendario-btn" matTooltip="Ver calendário de reservas" matTooltipClass="tavola-tooltip">
            <mat-icon>calendar_month</mat-icon>
      </button>
    </div>
  </div>

      <div class="mesas-container">
        <!-- HEADER COM AS ABAS DE AMBIENTE -->
        <div class="areas-header">
          
          <div class="ambientes-nav-wrapper">
            <!-- Setas de navegação -->
            <button mat-icon-button class="nav-arrow left-arrow" *ngIf="mostrarSetaEsquerda" (click)="scrollAmbientes('left')">
              <mat-icon>chevron_left</mat-icon>
            </button>
            
            <div class="ambientes-scroll-container" #ambientesScroll (scroll)="verificarVisibilidadeSetas()">
              <div class="ambientes-list">
                <div 
                  *ngFor="let ambiente of ambientes; let i = index" 
                  class="ambiente-btn-wrapper custom-tab-label" 
                  [class.active]="ambiente.id === ambienteAtivo?.id">
                  
                  <button class="ambiente-btn" (click)="selecionarAmbiente(ambiente)">
                    <span>{{ ambiente.nome }}</span>
                  </button>
                </div>
                </div>
              </div>
            
            <button mat-icon-button class="nav-arrow right-arrow" *ngIf="mostrarSetaDireita" (click)="scrollAmbientes('right')">
              <mat-icon>chevron_right</mat-icon>
              </button>
        </div>
      </div>

        <!-- Grid de mesas -->
        <div *ngIf="ambienteAtivo" class="mesas-grid-container">
          
          <div class="mesas-grid-css">
            
            <div *ngFor="let mesa of ambienteAtivo.mesas" class="mesa-wrapper-css">
              
              <div 
                class="mesa" 
                [ngClass]="{ 
                  'mesa-ocupada': mesa.status === 'OCUPADA', 
                  'mesa-reservada': mesa.status === 'RESERVADA',
                  'mesa-em-atendimento': mesa.status === 'EM_ATENDIMENTO',
                  'mesa-livre': mesa.status === 'LIVRE'
                }" 
                (click)="selecionarMesa(mesa)"
                [matTooltip]="getTooltipMesa(mesa)" 
                matTooltipClass="tavola-tooltip">
                
                
                <div class="mesa-visual" [ngClass]="{'mesa-circular': mesa.tipo === 'circular'}">
                  <!-- Tempo de ocupação no canto superior direito -->
                  <div class="tempo-ocupacao-overlay" *ngIf="(mesa.status === 'OCUPADA' || mesa.status === 'EM_ATENDIMENTO') && mesa.tempoOcupacao">
                    <span>{{ mesa.tempoOcupacao }}</span>
                  </div>
                  
                  <!-- Indicador de status no canto superior esquerdo -->
                  <mat-icon 
                    *ngIf="mesa.status !== 'LIVRE'" 
                    class="status-indicator-icon">
                    {{ getStatusIcon(mesa.status) }}
              </mat-icon>
              
                  <span class="mesa-capacidade">
                    {{ mesa.capacidade }}
                    <mat-icon class="person-icon">person</mat-icon>
                  </span>
                  
                  <!-- Overlay dos garçons no canto inferior direito -->
                  <div class="garcons-overlay" *ngIf="getGarcomsAtendendoMesa(mesa.id).length > 0">
                    <div *ngFor="let garcom of getGarcomsAtendendoMesa(mesa.id) | slice:0:2" 
                         class="avatar-garcom" 
                         [matTooltip]="garcom.nome" 
                         matTooltipClass="tavola-tooltip">
                      <img *ngIf="garcom.foto" [src]="garcom.foto" [alt]="garcom.nome"/>
                      <span *ngIf="!garcom.foto">{{ garcom.nome.substring(0,1) }}</span>
                    </div>
                    <div *ngIf="getGarcomsAtendendoMesa(mesa.id).length > 2" 
                         class="avatar-garcom mais-garcons" 
                         [matTooltip]="getNomesGarconsExtras(mesa.id)" 
                         matTooltipClass="tavola-tooltip">
                      +{{ getGarcomsAtendendoMesa(mesa.id).length - 2 }}
                    </div>
                  </div>
                </div>
                
                <div class="mesa-etiqueta" [ngClass]="{'mesa-vip': mesa.vip}">
                  <nz-icon *ngIf="mesa.vip" nzType="crown" nzTheme="outline" class="vip-icon"></nz-icon>
                  <span>{{ mesa.nome }}</span>
                </div>
                
              </div>
              
            </div>
            
          </div>
        </div>
        
        <div *ngIf="!ambienteAtivo && !isLoading.ambientes" class="empty-state">
          <nz-empty nzNotFoundContent="Nenhum ambiente encontrado."></nz-empty>
        </div>

        <div *ngIf="isLoading.ambientes" class="loading-state">
          <mat-progress-spinner diameter="50"></mat-progress-spinner>
        </div>
      </div>
    </div>

    <!-- Painel de Pedidos -->
    <div class="pedidos-column" *ngIf="visualizacaoAtiva === 'pedidos' || !isMobile">
      <div class="pedidos-header">
        <h3>Pedidos Ativos</h3>
        <button mat-stroked-button (click)="atualizarPedidos()">
          <mat-icon>refresh</mat-icon>
          Atualizar
        </button>
      </div>
      
      <div class="pedidos-list">
        <div *ngFor="let pedido of pedidosAtivos" class="pedido-card">
          <div class="pedido-header">
            <div class="mesa-info">
              <mat-icon>table_restaurant</mat-icon>
              <span>Mesa {{ pedido.mesaNome }}</span>
            </div>
            <div class="pedido-status" [ngClass]="'status-' + pedido.status.toLowerCase()">
              {{ pedido.status }}
            </div>
          </div>
          
          <div class="pedido-itens">
            <div *ngFor="let item of pedido.itens" class="pedido-item">
              <span class="item-quantidade">{{ item.quantidade }}x</span>
              <span class="item-nome">{{ item.nome }}</span>
              <span class="item-preco">{{ item.preco | currency:'BRL' }}</span>
            </div>
              </div>
              
              <div class="pedido-actions">
            <button mat-stroked-button (click)="adicionarItemPedido(pedido)">
              <mat-icon>add</mat-icon>
              Adicionar Item
            </button>
            <button mat-flat-button color="primary" (click)="verPedidoCompleto(pedido)">
              <mat-icon>visibility</mat-icon>
              Ver Completo
                </button>
              </div>
        </div>
        
        <div *ngIf="pedidosAtivos.length === 0" class="sem-pedidos">
          <nz-empty nzDescription="Nenhum pedido ativo no momento"></nz-empty>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Detalhes da Mesa -->
  <div class="tavola-dialog" *ngIf="mesaSelecionada" [class.mobile-fullscreen]="isMobile">
    <div class="dialog-container">
      <div class="dialog-header">
        <div class="header-icon">
          <mat-icon>table_restaurant</mat-icon>
        </div>
        <h1 mat-dialog-title>Mesa {{ mesaSelecionada.nome }}</h1>
        <p class="subtitle">Detalhes e informações da mesa</p>
        <button mat-icon-button (click)="fecharDetalhesMesa()" class="close-button">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <mat-dialog-content class="dialog-content">
      <div class="mesa-info">
        <div class="info-item">
          <mat-icon>table_restaurant</mat-icon>
          <div class="info-text">
            <span class="label">Capacidade</span>
            <span class="value">{{ mesaSelecionada.capacidade }} Pessoas</span>
          </div>
        </div>
        
        <div class="info-item">
          <mat-icon>schedule</mat-icon>
          <div class="info-text">
            <span class="label">Status</span>
            <span class="value">{{ getStatusText(mesaSelecionada.status) }}</span>
          </div>
        </div>
        
        <div class="info-item" *ngIf="mesaSelecionada.tempoOcupacao">
          <mat-icon>timer</mat-icon>
          <div class="info-text">
            <span class="label">Tempo Ocupada</span>
            <span class="value">{{ mesaSelecionada.tempoOcupacao }}</span>
          </div>
        </div>
        
        <div class="info-item" *ngIf="mesaSelecionada.reserva">
          <mat-icon>event</mat-icon>
          <div class="info-text">
            <span class="label">Reserva</span>
            <span class="value">{{ mesaSelecionada.reserva.cliente }} - {{ mesaSelecionada.reserva.horario }}</span>
          </div>
        </div>
      </div>
      
      <div class="garcoms-atendendo" *ngIf="getGarcomsAtendendoMesa(mesaSelecionada.id).length > 0">
        <h4>Garçons Atendendo</h4>
        <div class="garcoms-list">
          <div *ngFor="let garcom of getGarcomsAtendendoMesa(mesaSelecionada.id)" class="garcom-item">
            <nz-avatar [nzSize]="32" [nzSrc]="garcom.foto" nzIcon="person"></nz-avatar>
            <span>{{ garcom.nome }}</span>
          </div>
        </div>
      </div>
      
      <div class="mesa-actions">
        <button mat-flat-button color="primary" (click)="iniciarAtendimento(mesaSelecionada)" 
                *ngIf="mesaSelecionada.status === 'LIVRE' || mesaSelecionada.status === 'RESERVADA'">
          <mat-icon>person_add</mat-icon>
          Iniciar Atendimento
        </button>
        
        <button mat-stroked-button (click)="verCardapio()">
          <mat-icon>restaurant_menu</mat-icon>
          Ver Cardápio
        </button>
        
        <button mat-stroked-button (click)="liberarMesa(mesaSelecionada)" 
                *ngIf="mesaSelecionada.status === 'EM_ATENDIMENTO' || mesaSelecionada.status === 'OCUPADA'">
          <mat-icon>event_available</mat-icon>
          Liberar Mesa
                </button>
              </div>
      </mat-dialog-content>
        </div>
      </div>

  <!-- Modal do Cardápio -->
  <div class="tavola-dialog" *ngIf="mostrarCardapio">
    <div class="dialog-container">
      <div class="dialog-header">
        <div class="header-icon">
          <mat-icon>restaurant_menu</mat-icon>
        </div>
        <h1 mat-dialog-title>Cardápio</h1>
        <p class="subtitle">Selecione os itens para adicionar ao pedido</p>
        <button mat-icon-button (click)="fecharCardapio()" class="close-button">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <mat-dialog-content class="dialog-content">
      
      <div class="cardapio-categorias">
        <div *ngFor="let categoria of cardapioCategorias" class="categoria-section">
          <h4>{{ categoria.nome }}</h4>
          <div class="itens-grid">
            <div *ngFor="let item of categoria.itens" class="item-card" (click)="adicionarItemAoCarrinho(item)">
              <div class="item-info">
                <h5>{{ item.nome }}</h5>
                <p>{{ item.descricao }}</p>
                <span class="item-preco">{{ item.preco | currency:'BRL' }}</span>
              </div>
              <button mat-icon-button class="add-item-btn">
                <mat-icon>add</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>
      </mat-dialog-content>
        </div>
      </div>

  <!-- Modal do Calendário -->
  <div class="tavola-dialog" *ngIf="mostrarCalendario">
    <div class="dialog-container">
      <div class="dialog-header">
        <div class="header-icon">
          <mat-icon>calendar_today</mat-icon>
        </div>
        <h1 mat-dialog-title>Calendário de Reservas</h1>
        <p class="subtitle">Visualize as reservas por data</p>
        <button mat-icon-button (click)="mostrarCalendario = false" class="close-button">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <mat-dialog-content class="dialog-content">
        <app-calendario-reservas 
          [reservas]="getReservasParaCalendario()" 
          (dataSeleccionada)="selecionarDataDoCalendario($event)"
          (fechar)="mostrarCalendario = false">
        </app-calendario-reservas>
      </mat-dialog-content>
    </div>
  </div>
</div>


