<div class="reservas-container">
  <div class="reservas-content-columns">
    <div class="reservas-list-column">
      <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" (selectedTabChange)="mudarAba($event)">
        <mat-tab>
          <ng-template mat-tab-label>
            <span class="tab-label">Reservas</span>
            <span class="tab-badge">{{ reservasVisiveis.length }}</span>
          </ng-template>

          <div class="search-bar">
            <mat-form-field appearance="outline">
              <input matInput placeholder="Buscar por nome do cliente" [(ngModel)]="pesquisa" (input)="aplicarFiltros()">
              <button mat-icon-button matSuffix *ngIf="pesquisa" (click)="limparPesquisa()" aria-label="Limpar pesquisa">
                <mat-icon>close</mat-icon>
              </button>
              <button mat-icon-button matSuffix *ngIf="!pesquisa" aria-label="Buscar">
                <mat-icon>search</mat-icon>
              </button>
            </mat-form-field>
          </div>

          <div class="reservas-list">
            <div class="periodo-section" *ngIf="reservasAlmocoVisiveis.length > 0">
              <h3>Almoço</h3>
              <div class="reserva-cards">
                <mat-card *ngFor="let reserva of reservasAlmocoVisiveis" class="reserva-card" [class.selected]="reservaSelecionada?.id === reserva.id" (click)="selecionarReserva(reserva)">
                  <div class="reserva-info">
                    <div class="cliente-info">
                      <h4>{{ getClientePorId(reserva.clienteId)?.nome }}</h4>
                      <div class="reserva-detalhes">
                        <span class="pessoas-info">
                          <mat-icon>person</mat-icon>
                          {{ reserva.pessoas }} Pessoa(s)
                        </span>
                        <span class="mesa-info">
                           <mat-icon>table_restaurant</mat-icon>
                           {{ getMesasFormatadas(reserva) }}
                        </span>
                      </div>
                    </div>
                    <div class="reserva-acoes">
                      <button mat-icon-button [ngClass]="{'confirmada': reserva.status === 'confirmada', 'pendente': reserva.status === 'pendente', 'cancelada': reserva.status === 'cancelada'}" [matTooltip]="reserva.status | titlecase" aria-label="Status da reserva">
                        <mat-icon>{{ reserva.status === 'confirmada' ? 'check_circle' : (reserva.status === 'pendente' ? 'hourglass_empty' : 'cancel') }}</mat-icon>
                      </button>
                      <div class="horario">
                        {{ reserva.horario }}
                      </div>
                    </div>
                  </div>
                </mat-card>
              </div>
            </div>
            <div *ngIf="reservasAlmocoVisiveis.length === 0 && (periodoFiltro === 'todos' || periodoFiltro === 'Almoço') && (pesquisa.trim() === '' || (pesquisa.trim() !== '' && !temReservasParaPesquisaNoPeriodo('Almoço')))" class="sem-reservas">
              <nz-empty nzDescription="Sem reservas para o almoço nesta data com os filtros aplicados"></nz-empty>
            </div>

            <div class="periodo-section" *ngIf="reservasJantarVisiveis.length > 0">
              <h3>Jantar</h3>
              <div class="reserva-cards">
                <mat-card *ngFor="let reserva of reservasJantarVisiveis" class="reserva-card" [class.selected]="reservaSelecionada?.id === reserva.id" (click)="selecionarReserva(reserva)">
                   <div class="reserva-info">
                    <div class="cliente-info">
                      <h4>{{ getClientePorId(reserva.clienteId)?.nome }}</h4>
                      <div class="reserva-detalhes">
                        <span class="pessoas-info">
                          <mat-icon>person</mat-icon>
                          {{ reserva.pessoas }} Pessoa(s)
                        </span>
                         <span class="mesa-info">
                           <mat-icon>table_restaurant</mat-icon>
                           {{ getMesasFormatadas(reserva) }}
                        </span>
                      </div>
                    </div>
                    <div class="reserva-acoes">
                      <button mat-icon-button [ngClass]="{'confirmada': reserva.status === 'confirmada', 'pendente': reserva.status === 'pendente', 'cancelada': reserva.status === 'cancelada'}" [matTooltip]="reserva.status | titlecase" aria-label="Status da reserva">
                         <mat-icon>{{ reserva.status === 'confirmada' ? 'check_circle' : (reserva.status === 'pendente' ? 'hourglass_empty' : 'cancel') }}</mat-icon>
                      </button>
                      <div class="horario">
                        {{ reserva.horario }}
                      </div>
                    </div>
                  </div>
                </mat-card>
              </div>
            </div>
            <div *ngIf="reservasJantarVisiveis.length === 0 && (periodoFiltro === 'todos' || periodoFiltro === 'Jantar') && (pesquisa.trim() === '' || (pesquisa.trim() !== '' && !temReservasParaPesquisaNoPeriodo('Jantar')))" class="sem-reservas">
              <nz-empty nzDescription="Sem reservas para o jantar nesta data com os filtros aplicados"></nz-empty>
            </div>

            <div *ngIf="reservasVisiveis.length === 0 && pesquisa.trim() !== ''" class="sem-reservas">
                <nz-empty nzDescription="Nenhuma reserva encontrada para sua busca."></nz-empty>
            </div>
             <div *ngIf="reservasAlmocoVisiveis.length === 0 && reservasJantarVisiveis.length === 0 && pesquisa.trim() === '' && !existemReservasParaDataAtual()" class="sem-reservas">
                 <nz-empty nzDescription="Nenhuma reserva para a data selecionada."></nz-empty>
            </div>
          </div>
        </mat-tab>
        <mat-tab label="Lista de Espera">
           <div class="tab-content-placeholder"> <nz-empty nzDescription="Lista de espera vazia"></nz-empty>
          </div>
        </mat-tab>
        <mat-tab label="Garçons">
          <div class="tab-content-placeholder"> <nz-empty nzDescription="Nenhum garçom disponível"></nz-empty>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>

    <div class="reserva-details-tables-column">
      <div class="right-column-header">
        <div class="date-navigator">
          <button mat-icon-button (click)="diaAnterior()" aria-label="Dia anterior">
            <mat-icon>chevron_left</mat-icon>
          </button>
          <span class="current-date">{{ dataAtual | date:'dd/MM/yyyy' : '' : 'pt-BR' }} ({{ dataAtual | date:'EEEE' : '' : 'pt-BR' | titlecase }})</span>
          <button mat-icon-button (click)="proximoDia()" aria-label="Próximo dia">
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>
        <div class="table-actions">
          <button mat-stroked-button color="primary" (click)="abrirModalAdicionarMesa()">
            <mat-icon>add_circle_outline</mat-icon>Gerenciar Mesas
          </button>
        </div>
      </div>

      <ng-container *ngIf="reservaSelecionada; else mapaDeMesas">
        <div class="reserva-detalhes-container">
          <div class="detalhes-header">
            <button mat-icon-button (click)="fecharDetalhes()" class="back-button-details" matTooltip="Voltar para o mapa de mesas" aria-label="Voltar para mapa de mesas">
                <mat-icon>arrow_back</mat-icon>
            </button>
            <h2>Detalhes da Reserva #{{ reservaSelecionada.id.slice(-4) }}</h2>
          </div>
  
          <ng-container *ngIf="getClientePorId(reservaSelecionada.clienteId) as cliente">
             <div class="cliente-detalhes">
               <div class="cliente-header">
                 <nz-avatar [nzSize]="64" [nzSrc]="cliente.avatar" nzIcon="user"></nz-avatar>
                 <div class="cliente-info-principal">
                   <h3>{{ cliente.nome }}</h3>
                   <div class="cliente-contato">
                     <div class="contato-item">
                       <mat-icon>email</mat-icon>
                       <span>{{ cliente.email }}</span>
                     </div>
                     <div class="contato-item">
                       <mat-icon>phone</mat-icon>
                       <span>{{ cliente.telefone }}</span>
                     </div>
                   </div>
                 </div>
                 <div class="cliente-id">
                   <span>ID Cliente: #{{ cliente.id.slice(-5) }}</span>
                 </div>
               </div>
             </div>
 
             <div class="estatisticas">
               <h3>Informações</h3>
               <div class="estatisticas-grid">
                  <div class="estatistica-item">
                    <div class="estatistica-valor">{{ cliente.historico.proximas.toString().padStart(2, '0') }}</div>
                    <div class="estatistica-label">Próximas</div>
                  </div>
                  <div class="estatistica-item">
                    <div class="estatistica-valor">{{ cliente.historico.negadas.toString().padStart(2, '0') }}</div>
                    <div class="estatistica-label">Negadas</div>
                  </div>
                  <div class="estatistica-item">
                    <div class="estatistica-valor">{{ cliente.historico.canceladas.toString().padStart(2, '0') }}</div>
                    <div class="estatistica-label">Canceladas</div>
                  </div>
                  <div class="estatistica-item">
                    <div class="estatistica-valor">{{ cliente.historico.naoCompareceu.toString().padStart(2, '0') }}</div>
                    <div class="estatistica-label">Não Compareceu</div>
                  </div>
                  <div class="estatistica-item">
                    <div class="estatistica-valor">{{ cliente.historico.gastoMedio | currency:'BRL':'symbol':'1.0-0' }}</div>
                    <div class="estatistica-label">Gasto/Pessoa</div>
                  </div>
                  <div class="estatistica-item">
                    <div class="estatistica-valor">{{ cliente.historico.gastoTotal | currency:'BRL':'symbol':'1.0-0' }}</div>
                    <div class="estatistica-label">Gasto Total</div>
                  </div>
               </div>
             </div>
 
              <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" class="detalhes-tabs">
                 <mat-tab label="Detalhes">
                   <div class="detalhes-content">
                     <div class="secao-detalhes">
                       <div class="secao-header">
                         <h4>Detalhes da Reserva</h4>
                       </div>
                       <div class="info-grid">
                         <div class="info-row">
                          <div class="info-label">Data</div>
                          <div class="info-valor">
                            <div class="data-com-icone">
                              <span>{{ formatarData(reservaSelecionada.data) }}</span>
                              <mat-icon>calendar_today</mat-icon>
                            </div>
                          </div>
                        </div>
                        <div class="info-row">
                          <div class="info-label">Horário</div>
                          <div class="info-valor">
                            <div class="data-com-icone">
                              <span>{{ reservaSelecionada.horario }}</span>
                              <mat-icon>access_time</mat-icon>
                            </div>
                          </div>
                        </div>
                        <div class="info-row">
                          <div class="info-label">Pessoas</div>
                          <div class="info-valor">{{ reservaSelecionada.pessoas }}</div>
                        </div>
                         <div class="info-row">
                          <div class="info-label">Status</div>
                          <div class="info-valor">
                            <nz-tag [nzColor]="reservaSelecionada.status === 'confirmada' ? 'green' : (reservaSelecionada.status === 'pendente' ? 'gold' : 'red')">{{ reservaSelecionada.status | titlecase }}</nz-tag>
                          </div>
                        </div>
                        <div class="info-row">
                          <div class="info-label">Duração</div>
                          <div class="info-valor">{{ reservaSelecionada.duracao }}</div>
                        </div>
                       </div>
 
                       <div class="secao-header mesas-atribuidas-header">
                           <h4>Mesas Atribuídas</h4>
                       </div>
                       <div class="mesas-atribuidas-lista" *ngIf="reservaSelecionada.mesaIds.length > 0; else nenhumaMesaAtribuida">
                           <div *ngFor="let mesaId of reservaSelecionada.mesaIds" class="mesa-atribuida-item">
                               <mat-icon class="mesa-atribuida-icone">table_restaurant</mat-icon>
                               <span class="mesa-atribuida-nome">{{ getMesaPorId(mesaId)?.numero }}</span>
                               <button mat-icon-button color="warn" (click)="removerMesaDaReserva(reservaSelecionada!.id, mesaId)" matTooltip="Desassociar mesa" aria-label="Desassociar mesa">
                                   <mat-icon>close</mat-icon>
                               </button>
                           </div>
                       </div>
                       <ng-template #nenhumaMesaAtribuida>
                           <p class="info-placeholder">Nenhuma mesa atribuída. Selecione mesas no mapa abaixo.</p>
                       </ng-template>
 
                       <div class="comentarios-notas">
                         <div class="comentarios">
                           <h5>Comentários</h5>
                           <p>{{ reservaSelecionada.comentarios || 'Nenhum comentário.' }}</p>
                         </div>
                         <div class="notas">
                           <h5>Notas</h5>
                           <p>{{ reservaSelecionada.notas || 'Nenhuma nota.' }}</p>
                         </div>
                       </div>
                     </div>
                   </div>
                 </mat-tab>
                  <mat-tab label="Mensagens"> <div class="tab-content-placeholder"><nz-empty nzDescription="Sem mensagens"></nz-empty></div> </mat-tab>
                  <mat-tab label="Pagamento"> <div class="tab-content-placeholder"><nz-empty nzDescription="Sem dados de pagamento"></nz-empty></div> </mat-tab>
                  <mat-tab label="PDV"> <div class="tab-content-placeholder"><nz-empty nzDescription="Sem dados de PDV"></nz-empty></div> </mat-tab>
              </mat-tab-group>
           </ng-container>
        </div>
      </ng-container>

      <ng-template #mapaDeMesas>
        <div class="mesas-container">
          <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" (selectedTabChange)="mudarArea($event)">
            <mat-tab *ngFor="let area of areas" [label]="area"></mat-tab>
          </mat-tab-group>
          <div class="mesas-grid">
            <div *ngFor="let mesa of getMesasPorArea(areaAtiva)"
                 class="mesa"
                 [ngClass]="{
                   'mesa-circular': mesa.tipo === 'circular',
                   'mesa-vip': mesa.vip,
                   'mesa-ocupada': isMesaOcupadaPorOutraReserva(mesa.id),
                   'mesa-atribuida-reserva-atual': isMesaAtribuidaAReservaAtual(mesa.id)
                 }"
                 (click)="toggleMesaParaReserva(mesa)"
                 [matTooltip]="isMesaOcupadaPorOutraReserva(mesa.id) ? 'Ocupada por: ' + (getClientePorId(getReservaPorId(mesa.reservaId!)?.clienteId!)?.nome || 'Outra reserva') : (isMesaAtribuidaAReservaAtual(mesa.id) ? 'Atribuída a esta reserva (' + (getClientePorId(reservaSelecionada?.clienteId || '')?.nome || '') + ')' : 'Disponível - Capacidade: ' + (mesa.capacidade || 'N/A') + 'P')"
                 matTooltipPosition="above">
              <div class="mesa-visual" [class.mesa-visual-circular]="mesa.tipo === 'circular'">
                </div>
              <span class="mesa-identificador">{{ mesa.numero }}</span>
            </div>
          </div>
        </div>
      </ng-template>
    </div>
  </div>

  <button mat-fab class="fab-adicionar-reserva" matTooltip="Adicionar Nova Reserva" aria-label="Adicionar Nova Reserva" (click)="abrirModalAdicionarReserva()">
    <mat-icon>add</mat-icon>
  </button>
</div>

<ng-template #modalMesa>
  <form nz-form> <mat-form-field appearance="outline" class="full-width modal-form-field">
      <mat-label>Número/Nome da Mesa</mat-label>
      <input matInput [(ngModel)]="mesaEditando.numero" name="numeroMesaModal" required>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width modal-form-field">
      <mat-label>Área</mat-label>
      <mat-select [(ngModel)]="mesaEditando.area" name="areaMesaModal" required>
        <mat-option *ngFor="let area of areas" [value]="area">{{ area }}</mat-option>
      </mat-select>
    </mat-form-field>
    
    <mat-form-field appearance="outline" class="full-width modal-form-field">
      <mat-label>Capacidade</mat-label>
      <input matInput type="number" [(ngModel)]="mesaEditando.capacidade" name="capacidadeMesaModal" min="1">
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width modal-form-field">
      <mat-label>Tipo de Mesa</mat-label>
      <mat-select [(ngModel)]="mesaEditando.tipo" name="tipoMesaModal" required>
        <mat-option value="retangular">Retangular</mat-option>
        <mat-option value="circular">Circular</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-checkbox [(ngModel)]="mesaEditando.vip" name="vipMesaModal" class="modal-checkbox-vip">
      Mesa VIP
    </mat-checkbox>
  </form>
  <div class="modal-actions-delete" *ngIf="mesaEditando?.id">
      <button mat-stroked-button color="warn" (click)="excluirMesa(mesaEditando.id!)">
          <mat-icon>delete</mat-icon>
          Excluir Mesa
      </button>
  </div>
</ng-template>