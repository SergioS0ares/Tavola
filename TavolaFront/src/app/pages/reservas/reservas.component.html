<div class="reservas-container">
  <div class="reservas-content-columns">
    <div class="reservas-list-column">
      <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="center" (selectedTabChange)="mudarAba($event)">
        <mat-tab>
          <ng-template mat-tab-label>
            <span class="tab-label">Reservas</span>
            <span class="tab-badge">{{ reservasVisiveis.length }}</span>
          </ng-template>

          <div class="search-bar">
            <mat-form-field appearance="outline">
              <input matInput placeholder="Buscar por nome do cliente" [(ngModel)]="pesquisa" (input)="aplicarFiltros()">
              <button mat-icon-button matSuffix *ngIf="pesquisa" (click)="limparPesquisa()" aria-label="Limpar pesquisa">
                <mat-icon>close</mat-icon>
              </button>
              <button mat-icon-button matSuffix *ngIf="!pesquisa" aria-label="Buscar">
                <mat-icon>search</mat-icon>
              </button>
            </mat-form-field>
          </div>

          <div class="reservas-list">
            <div class="periodo-section" *ngIf="reservasAlmocoVisiveis.length > 0">
              <h3>Almoço</h3>
              <div class="reserva-cards">
                <mat-card *ngFor="let reserva of reservasAlmocoVisiveis" class="reserva-card" [class.selected]="reservaSelecionada?.id === reserva.id" (click)="selecionarReserva(reserva)">
                  <div class="reserva-info">
                    <div class="cliente-info">
                      <h4>{{ getClientePorId(reserva.clienteId)?.nome }}</h4>
                      <div class="reserva-detalhes">
                        <span class="pessoas-info">
                          <mat-icon>person</mat-icon>
                          {{ reserva.pessoas }} Pessoa(s)
                        </span>
                        <span class="mesa-info">
                           <mat-icon>table_restaurant</mat-icon>
                           {{ getMesasFormatadas(reserva) }}
                        </span>
                      </div>
                    </div>
                    <div class="reserva-acoes">
                      <button mat-icon-button 
                        [ngClass]="{'confirmada': reserva.status === 'confirmada', 'pendente': reserva.status === 'pendente', 'cancelada': reserva.status === 'cancelada'}" 
                        [matTooltip]="getTooltipStatus(reserva.status)" 
                        matTooltipClass="tavola-tooltip"
                        aria-label="Status da reserva">
                        <mat-icon>{{ reserva.status === 'confirmada' ? 'check_circle' : (reserva.status === 'pendente' ? 'hourglass_empty' : 'cancel') }}</mat-icon>
                      </button>
                      <div class="horario">
                        {{ reserva.horario }}
                      </div>
                    </div>
                  </div>
                </mat-card>
              </div>
            </div>
            <div *ngIf="reservasAlmocoVisiveis.length === 0 && (periodoFiltro === 'todos' || periodoFiltro === 'Almoço') && (pesquisa.trim() === '' || (pesquisa.trim() !== '' && !temReservasParaPesquisaNoPeriodo('Almoço')))" class="sem-reservas">
              <nz-empty nzDescription="Sem reservas para o almoço nesta data com os filtros aplicados"></nz-empty>
            </div>

            <div class="periodo-section" *ngIf="reservasJantarVisiveis.length > 0">
              <h3>Jantar</h3>
              <div class="reserva-cards">
                <mat-card *ngFor="let reserva of reservasJantarVisiveis" class="reserva-card" [class.selected]="reservaSelecionada?.id === reserva.id" (click)="selecionarReserva(reserva)">
                   <div class="reserva-info">
                    <div class="cliente-info">
                      <h4>{{ getClientePorId(reserva.clienteId)?.nome }}</h4>
                      <div class="reserva-detalhes">
                        <span class="pessoas-info">
                          <mat-icon>person</mat-icon>
                          {{ reserva.pessoas }} Pessoa(s)
                        </span>
                         <span class="mesa-info">
                           <mat-icon>table_restaurant</mat-icon>
                           {{ getMesasFormatadas(reserva) }}
                        </span>
                      </div>
                    </div>
                    <div class="reserva-acoes">
                      <button mat-icon-button 
                        [ngClass]="{'confirmada': reserva.status === 'confirmada', 'pendente': reserva.status === 'pendente', 'cancelada': reserva.status === 'cancelada'}" 
                        [matTooltip]="getTooltipStatus(reserva.status)" 
                        matTooltipClass="tavola-tooltip"
                        aria-label="Status da reserva">
                         <mat-icon>{{ reserva.status === 'confirmada' ? 'check_circle' : (reserva.status === 'pendente' ? 'hourglass_empty' : 'cancel') }}</mat-icon>
                      </button>
                      <div class="horario">
                        {{ reserva.horario }}
                      </div>
                    </div>
                  </div>
                </mat-card>
              </div>
            </div>
            <div *ngIf="reservasJantarVisiveis.length === 0 && (periodoFiltro === 'todos' || periodoFiltro === 'Jantar') && (pesquisa.trim() === '' || (pesquisa.trim() !== '' && !temReservasParaPesquisaNoPeriodo('Jantar')))" class="sem-reservas">
              <nz-empty nzDescription="Sem reservas para o jantar nesta data com os filtros aplicados"></nz-empty>
            </div>

            <div *ngIf="reservasVisiveis.length === 0 && pesquisa.trim() !== ''" class="sem-reservas">
                <nz-empty nzDescription="Nenhuma reserva encontrada para sua busca."></nz-empty>
            </div>
             <div *ngIf="reservasAlmocoVisiveis.length === 0 && reservasJantarVisiveis.length === 0 && pesquisa.trim() === '' && !existemReservasParaDataAtual()" class="sem-reservas">
                 <nz-empty nzDescription="Nenhuma reserva para a data selecionada."></nz-empty>
            </div>
          </div>
        </mat-tab>
        <mat-tab label="Lista de Espera">
          <div class="search-bar">
            <mat-form-field appearance="outline">
              <input matInput placeholder="Buscar por nome do cliente" [(ngModel)]="pesquisaEspera" (input)="aplicarFiltrosEspera()">
              <button mat-icon-button matSuffix *ngIf="pesquisaEspera" (click)="limparPesquisaEspera()" aria-label="Limpar pesquisa">
                <mat-icon>close</mat-icon>
              </button>
              <button mat-icon-button matSuffix *ngIf="!pesquisaEspera" aria-label="Buscar">
                <mat-icon>search</mat-icon>
              </button>
            </mat-form-field>
          </div>
          
          <div class="tab-content-placeholder" *ngIf="reservasEsperaVisiveis.length === 0">
            <nz-empty nzDescription="Lista de espera vazia"></nz-empty>
          </div>
          <div class="reservas-list" *ngIf="reservasEsperaVisiveis.length > 0">
            <div class="reserva-cards">
              <mat-card *ngFor="let reserva of reservasEsperaVisiveis" class="reserva-card" [class.selected]="reservaSelecionada?.id === reserva.id" (click)="selecionarReserva(reserva)">
                <div class="reserva-info">
                  <div class="cliente-info">
                    <h4>{{ getClientePorId(reserva.clienteId)?.nome }}</h4>
                    <div class="reserva-detalhes">
                      <span class="pessoas-info">
                        <mat-icon>person</mat-icon>
                        {{ reserva.pessoas }} Pessoa(s)
                      </span>
                      <span class="mesa-info">
                        <mat-icon>table_restaurant</mat-icon>
                        {{ getMesasFormatadas(reserva) }}
                      </span>
                      <span class="data-info">
                        <mat-icon>calendar_today</mat-icon>
                        {{ formatarData(reserva.data) }}
                      </span>
                    </div>
                  </div>
                  <div class="reserva-acoes">
                    <span class="horario">{{ reserva.horario }}</span>
                    <button mat-icon-button 
                      class="reatribuir-btn"
                      (click)="reatribuirReserva(reserva, $event)"
                      matTooltip="Reatribuir para data atual" 
                      matTooltipClass="tavola-tooltip"
                      aria-label="Reatribuir reserva">
                      <mat-icon>event_available</mat-icon>
                    </button>
                  </div>
                </div>
              </mat-card>
            </div>
          </div>
        </mat-tab>
        <mat-tab label="Garçons">
          <div class="tab-content-placeholder"> <nz-empty nzDescription="Nenhum garçom disponível"></nz-empty>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>

    <div class="reserva-details-tables-column">
      <div class="right-column-header">
        <div class="date-navigator-area">
          <div class="date-navigator">
            <button mat-icon-button (click)="diaAnterior()" aria-label="Dia anterior">
              <mat-icon>chevron_left</mat-icon>
            </button>
            <nz-date-picker
              nzFormat="dd/MM/yyyy"
              [(ngModel)]="dataAtual"
              (ngModelChange)="nzDatePickerChange($event)"
              nzAllowClear="false"
            ></nz-date-picker>
            <button mat-icon-button (click)="proximoDia()" aria-label="Próximo dia">
              <mat-icon>chevron_right</mat-icon>
            </button>
            <button mat-icon-button (click)="mostrarCalendario = true" class="calendario-btn" matTooltip="Ver calendário de reservas" matTooltipClass="tavola-tooltip">
              <mat-icon>calendar_month</mat-icon>
            </button>
          </div>
          <div class="table-actions">
            <button
              mat-fab
              color="primary"
              class="fab-add-reservas"
              aria-label="Gerenciar Mesas"
              matTooltip="Adicionar, Editar ou Remover Mesas"
              matTooltipClass="tavola-tooltip"
              (click)="abrirModalGerenciarMesas()">
              <mat-icon>add</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <ng-container *ngIf="reservaSelecionada; else mapaDeMesas">
        <div class="reserva-detalhes-container">
          <div class="detalhes-header">
            <button mat-icon-button (click)="fecharDetalhes()" class="back-button-details" matTooltip="Voltar para o mapa de mesas" matTooltipClass="tavola-tooltip" aria-label="Voltar para mapa de mesas">
                <mat-icon>arrow_back</mat-icon>
            </button>
            <h2>Detalhes da Reserva #{{ reservaSelecionada.id.slice(-4) }}</h2>
          </div>
  
          <ng-container *ngIf="getClientePorId(reservaSelecionada.clienteId) as cliente">
             <div class="cliente-detalhes">
               <div class="cliente-header">
                 <nz-avatar [nzSize]="64" [nzSrc]="cliente.avatar" nzIcon="user"></nz-avatar>
                 <div class="cliente-info-principal">
                   <h3>{{ cliente.nome }}</h3>
                   <div class="cliente-contato">
                     <div class="contato-item">
                       <mat-icon>email</mat-icon>
                       <span>{{ cliente.email }}</span>
                     </div>
                     <div class="contato-item">
                       <mat-icon>phone</mat-icon>
                       <span>{{ cliente.telefone }}</span>
                     </div>
                   </div>
                 </div>
                 <div class="cliente-id">
                   <span>ID Cliente: #{{ cliente.id.slice(-5) }}</span>
                 </div>
               </div>
             </div>
             
              <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" class="detalhes-tabs">
                 <mat-tab label="Detalhes">
                   <div class="detalhes-content">
                     <div class="secao-detalhes">
                       <div class="secao-header">
                         <h4>Detalhes da Reserva</h4>
                       </div>
                       <div class="info-grid">
                         <div class="info-row">
                          <div class="info-label">Data</div>
                          <div class="info-valor">
                            <div class="data-com-icone">
                              <span>{{ formatarData(reservaSelecionada.data) }}</span>
                              <mat-icon>calendar_today</mat-icon>
                            </div>
                          </div>
                        </div>
                        <div class="info-row">
                          <div class="info-label">Horário</div>
                          <div class="info-valor">
                            <div class="data-com-icone">
                              <span>{{ reservaSelecionada.horario }}</span>
                              <mat-icon>access_time</mat-icon>
                            </div>
                          </div>
                        </div>
                        <div class="info-row">
                          <div class="info-label">Pessoas</div>
                          <div class="info-valor">{{ reservaSelecionada.pessoas }}</div>
                        </div>
                        
                        <!-- Status e Associar Mesas apenas para reservas normais, não para lista de espera -->
                        <ng-container *ngIf="reservaSelecionada.status !== 'espera'">
                          <div class="info-row-centered">
                            <div class="info-label">Status</div>
                            <div class="info-valor">
                              <mat-form-field appearance="outline" class="status-dropdown">
                                <mat-select [(value)]="reservaSelecionada.status" (selectionChange)="atualizarStatusReserva($event.value)"
                                  [ngClass]="{
                                    'status-confirmada': reservaSelecionada.status === 'confirmada',
                                    'status-pendente': reservaSelecionada.status === 'pendente',
                                    'status-cancelada': reservaSelecionada.status === 'cancelada',
                                    'status-finalizada': reservaSelecionada.status === 'finalizada',
                                    'status-ausente': reservaSelecionada.status === 'ausente'
                                  }">
                                  <mat-option value="pendente">Pendente</mat-option>
                                  <mat-option value="confirmada">Confirmada</mat-option>
                                  <mat-option value="cancelada">Cancelada</mat-option>
                                  <mat-option value="finalizada">Finalizada</mat-option>
                                  <mat-option value="ausente">Ausente</mat-option>
                                  <mat-option value="espera">Espera</mat-option>
                                </mat-select>
                              </mat-form-field>
                            </div>
                          </div>

                          <div class="info-row-centered">
                            <div class="info-label">Associar Mesas</div>
                            <div class="info-valor">
                              <mat-form-field appearance="outline" class="mesas-dropdown">
                                <mat-select multiple [(value)]="reservaSelecionada.mesaIds" (selectionChange)="atualizarMesasReserva($event.value)">
                                  <mat-option *ngFor="let mesa of getMesasDisponiveis()" [value]="mesa.id">
                                    {{ mesa.numero }} - {{ mesa.area }} ({{ mesa.capacidade }}P)
                                  </mat-option>
                                </mat-select>
                              </mat-form-field>
                            </div>
                          </div>
                        </ng-container>
                        
                        <!-- Botão de reatribuir para lista de espera -->
                        <div class="info-row-centered" *ngIf="reservaSelecionada.status === 'espera'">
                          <button mat-flat-button class="reatribuir-btn-grande" (click)="reatribuirReserva(reservaSelecionada, $event)">
                            <mat-icon>event_available</mat-icon>
                            Reatribuir para {{ formatarDataSimples(dataAtual) }}
                          </button>
                        </div>
                       </div>
 
                       <div class="secao-header mesas-atribuidas-header">
                           <h4>Mesas Atribuídas</h4>
                       </div>
                       <div class="mesas-atribuidas-chips" *ngIf="reservaSelecionada.mesaIds.length > 0; else nenhumaMesaAtribuida">
                           <div class="mesa-chip" *ngFor="let mesaId of reservaSelecionada.mesaIds">
                               <span class="mesa-nome">{{ getMesaPorId(mesaId)?.numero }}</span>
                               <button mat-icon-button class="remove-mesa-btn" (click)="removerMesaDaReserva(reservaSelecionada!.id, mesaId)" 
                                       matTooltip="Desassociar mesa" matTooltipClass="tavola-tooltip" aria-label="Desassociar mesa">
                                   <mat-icon>close</mat-icon>
                               </button>
                           </div>
                       </div>
                       <ng-template #nenhumaMesaAtribuida>
                           <p class="info-placeholder">Nenhuma mesa atribuída. Selecione mesas no mapa abaixo.</p>
                       </ng-template>
 
                       <div class="comentarios-notas">
                         <div class="comentarios">
                           <h5>Preferências</h5>
                           <p>{{ reservaSelecionada.preferencias || 'Nenhuma preferência.' }}</p>
                         </div>
                       </div>
                     </div>
                   </div>
                 </mat-tab>
                  <mat-tab label="Mensagens"> <div class="tab-content-placeholder"><nz-empty nzDescription="Sem mensagens"></nz-empty></div> </mat-tab>
                  <mat-tab label="Pagamento"> <div class="tab-content-placeholder"><nz-empty nzDescription="Sem dados de pagamento"></nz-empty></div> </mat-tab>
                  <mat-tab label="PDV"> <div class="tab-content-placeholder"><nz-empty nzDescription="Sem dados de PDV"></nz-empty></div> </mat-tab>
              </mat-tab-group>
           </ng-container>
        </div>
      </ng-container>

      <ng-template #mapaDeMesas>
        <div class="mesas-container">
          <div class="areas-header">
            <mat-tab-group
              mat-stretch-tabs="false"
              mat-align-tabs="start"
              [(selectedIndex)]="areaAtivaIndex"
            >
              <mat-tab *ngFor="let area of areasMesa; let i = index">
                <ng-template mat-tab-label>
                  <div class="custom-tab-label">
                    <span *ngIf="editandoIndex !== i" class="area-name">{{ area }}</span>

                    <input
                      *ngIf="editandoIndex === i"
                      matInput
                      [(ngModel)]="valorEditado"
                      (keydown.enter)="salvarEdicao(i)"
                      (keydown.escape)="cancelarEdicao()"
                      (blur)="salvarEdicao(i)"
                      (click)="$event.stopPropagation()"
                      cdkFocusInitial
                      class="edit-input"
                    />

                    <button
                      mat-icon-button
                      [matMenuTriggerFor]="areaMenu"
                      (click)="$event.stopPropagation()"
                      class="area-menu-trigger"
                      *ngIf="editandoIndex !== i"
                    >
                      <mat-icon>more_vert</mat-icon>
                    </button>
                  </div>
                  
                  <mat-menu #areaMenu="matMenu">
                    <button mat-menu-item (click)="iniciarEdicao(i, area)">
                      <mat-icon>edit</mat-icon>
                      <span>Editar Nome</span>
                    </button>
                    <button mat-menu-item (click)="confirmarRemocaoArea(i)">
                      <mat-icon>delete</mat-icon>
                      <span>Remover Área</span>
                    </button>
                  </mat-menu>
                </ng-template>
              </mat-tab>

              <mat-tab [disabled]="false">
                <ng-template mat-tab-label>
                  <div class="add-area-tab-label">
                    <button
                      mat-stroked-button
                      class="add-area-btn"
                      (click)="ativarModoAdicionar()"
                      *ngIf="!adicionandoArea"
                    >
                      <mat-icon>add</mat-icon>
                      Nova Área
                    </button>
                    <mat-form-field appearance="outline" class="add-area-input" *ngIf="adicionandoArea">
                      <input
                        matInput
                        placeholder="Nome da Área"
                        [(ngModel)]="nomeNovaArea"
                        (keydown.enter)="salvarNovaArea()"
                        (keydown.escape)="cancelarAdicionar()"
                        (blur)="salvarNovaArea()"
                        cdkFocusInitial
                      />
                    </mat-form-field>
                  </div>
                </ng-template>
              </mat-tab>
            </mat-tab-group>
          </div>

          <div class="mesas-grid">
            <div *ngFor="let mesa of getMesasPorArea(areaAtiva)"
                 class="mesa"
                 [ngClass]="{
                   'mesa-circular': mesa.tipo === 'circular',
                   'mesa-vip': mesa.vip,
                   'mesa-ocupada': isMesaOcupadaPorOutraReserva(mesa.id),
                   'mesa-atribuida-reserva-atual': isMesaAtribuidaAReservaAtual(mesa.id)
                 }"
                 (click)="toggleMesaParaReserva(mesa)"
                 [matTooltip]="getTooltipMesa(mesa)"
                 matTooltipClass="tavola-tooltip"
                 matTooltipPosition="above">
              
              <!-- Menu de 3 pontinhos -->
              <div class="mesa-menu" (click)="$event.stopPropagation()">
                <button mat-icon-button [matMenuTriggerFor]="mesaMenu" aria-label="Opções da mesa">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #mesaMenu="matMenu">
                  <button mat-menu-item (click)="editarMesa(mesa)">
                    <mat-icon>edit</mat-icon>
                    <span>Editar</span>
                  </button>
                  <button mat-menu-item (click)="confirmarRemocaoMesa(mesa)">
                    <mat-icon>delete</mat-icon>
                    <span>Remover</span>
                  </button>
                </mat-menu>
              </div>

              <div class="mesa-visual" [ngClass]="{'mesa-circular': mesa.tipo === 'circular'}">
                <span class="mesa-capacidade">{{ mesa.capacidade || 'N/A' }} P</span>
              </div>
              <div class="mesa-etiqueta" [ngClass]="{'mesa-vip': mesa.vip}">
                {{ mesa.numero }}
              </div>
            </div>
          </div>
        </div>
      </ng-template>
    </div>
  </div>
  
  <!-- Modal do Calendário -->
  <div class="calendario-modal" *ngIf="mostrarCalendario">
    <div class="calendario-overlay" (click)="mostrarCalendario = false"></div>
    <app-calendario-reservas 
      [reservas]="getReservasParaCalendario()" 
      (dataSeleccionada)="selecionarDataDoCalendario($event)"
      (fechar)="mostrarCalendario = false">
    </app-calendario-reservas>
  </div>
</div>