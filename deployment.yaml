apiVersion: apps/v1
kind: Deployment
metadata:
  name: tavola-backend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: tavola-backend
  template:
    metadata:
      labels:
        app: tavola-backend
    spec:
      volumes:
        - name: uploads-storage
          persistentVolumeClaim:
            claimName: tavola-uploads-pvc
        - name: nginx-config-volume
          configMap:
            name: nginx-config
      containers:
        # --- CONTÊINER DA API JAVA - COM VARIÁVEIS DE AMBIENTE ---
        - name: tavola-api-container
          image: tavola-api:local
          imagePullPolicy: Never
          ports:
            - containerPort: 8080
          
          # <<< SEÇÃO ADICIONADA >>>
          # Injeta as configurações para a aplicação Spring Boot
          env:
            - name: SPRING_DATASOURCE_URL
              value: "jdbc:postgresql://host.docker.internal:5432/tavola_db"
            - name: SPRING_DATASOURCE_USERNAME
              value: "postgres"
            - name: SPRING_DATASOURCE_PASSWORD
              value: "Aluno"
            - name: APP_UPLOAD_DIR
              value: "/app/uploads"
            - name: APP_CORS_ALLOWED_ORIGINS
              value: "http://localhost,http://localhost:4200,http://localhost:8080,http://64.181.187.11"
          
          volumeMounts:
            - mountPath: /app/uploads
              name: uploads-storage

        # --- CONTÊINER NGINX (permanece igual) ---
        - name: nginx-sidecar-container
          image: nginx:latest
          ports:
            - containerPort: 8081
          volumeMounts:
            - mountPath: /app/uploads
              name: uploads-storage
            - mountPath: /etc/nginx/conf.d/default.conf
              name: nginx-config-volume
              subPath: nginx.conf